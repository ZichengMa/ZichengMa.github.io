<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="https://zichengma.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://zichengma.github.io/" rel="alternate" type="text/html" hreflang="en"/><updated>2023-09-15T01:42:05+00:00</updated><id>https://zichengma.github.io/feed.xml</id><title type="html">blank</title><subtitle>A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. </subtitle><entry><title type="html">k8s operator practice</title><link href="https://zichengma.github.io/blog/2023/k8s-operator-practice/" rel="alternate" type="text/html" title="k8s operator practice"/><published>2023-03-26T20:28:15+00:00</published><updated>2023-03-26T20:28:15+00:00</updated><id>https://zichengma.github.io/blog/2023/k8s-operator-practice</id><content type="html" xml:base="https://zichengma.github.io/blog/2023/k8s-operator-practice/"><![CDATA[<p>I am learning how to write Kubernetes operator these days. This post is used to record some basic definition and a very good sample controller implemented by <a href="http://workshop.coreostrain.me/lab/go-operator/podset/">RedHat</a>.</p> <h3 id="introduction-to-kubernetes-operators">Introduction to Kubernetes Operators</h3> <p>Kubernetes is a powerful platform for managing containerized applications at scale. While Kubernetes provides a robust set of primitives for deploying and managing applications, it can be challenging to build and manage complex applications using only these primitives. This is where Kubernetes Operators come in.</p> <p>An Operator is a method of packaging, deploying, and managing a Kubernetes application. Operators use custom resources, controllers, and reconciliation loops to automate the deployment and management of complex applications on Kubernetes. In this article, we will explore the concept of Operators in Kubernetes and dive into the details of building an Operator using Go.</p> <h3 id="reconciler-overview">Reconciler Overview</h3> <p>One of the key components of a Kubernetes Operator is the reconciler. The reconciler is responsible for comparing the desired state of a Kubernetes resource with its current state and taking actions to reconcile any differences between the two.</p> <p>In Go-based Kubernetes Operators, the reconciler is typically implemented as a controller. The controller watches for changes to a specific type of Kubernetes resource, and when a change is detected, it initiates a reconciliation loop. During the reconciliation loop, the controller retrieves the current state of the resource from the Kubernetes API server, compares it with the desired state, and takes actions to reconcile any differences.</p> <h3 id="code-analysis">Code analysis</h3> <p>The CRDs we defined is PodSet. Spec: Replicas(How many pods we want) Status: ReadyReplicas(The number of ready replicas) PodNames(A slice for all ready replicas name) Controller will try to update Status.ReadyReplicas = Spec.Replicas and up/down scaling pods based on the difference.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
Copyright 2023.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/</span>

<span class="k">package</span> <span class="n">controllers</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"context"</span>
	<span class="s">"reflect"</span>

	<span class="n">corev1</span> <span class="s">"k8s.io/api/core/v1"</span>
	<span class="s">"k8s.io/apimachinery/pkg/api/errors"</span>
	<span class="n">metav1</span> <span class="s">"k8s.io/apimachinery/pkg/apis/meta/v1"</span>
	<span class="s">"k8s.io/apimachinery/pkg/labels"</span>
	<span class="s">"k8s.io/apimachinery/pkg/runtime"</span>
	<span class="n">ctrl</span> <span class="s">"sigs.k8s.io/controller-runtime"</span>
	<span class="s">"sigs.k8s.io/controller-runtime/pkg/client"</span>
	<span class="s">"sigs.k8s.io/controller-runtime/pkg/controller/controllerutil"</span>
	<span class="s">"sigs.k8s.io/controller-runtime/pkg/log"</span>

	<span class="n">batchv1</span> <span class="s">"tutorial.kubebuilder.io/operator-practice/api/v1"</span>
<span class="p">)</span>

<span class="c">// PodSetReconciler reconciles a PodSet object</span>
<span class="k">type</span> <span class="n">PodSetReconciler</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">client</span><span class="o">.</span><span class="n">Client</span>
	<span class="n">Scheme</span> <span class="o">*</span><span class="n">runtime</span><span class="o">.</span><span class="n">Scheme</span>
<span class="p">}</span>

<span class="c">//+kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=podsets,verbs=get;list;watch;create;update;patch;delete</span>
<span class="c">//+kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=podsets/status,verbs=get;update;patch</span>
<span class="c">//+kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=podsets/finalizers,verbs=update</span>

<span class="c">// Reconcile is part of the main kubernetes reconciliation loop which aims to</span>
<span class="c">// move the current state of the cluster closer to the desired state.</span>
<span class="c">// TODO(user): Modify the Reconcile function to compare the state specified by</span>
<span class="c">// the PodSet object against the actual cluster state, and then</span>
<span class="c">// perform operations to make the cluster state reflect the state specified by</span>
<span class="c">// the user.</span>
<span class="c">//</span>
<span class="c">// For more details, check Reconcile and its Result here:</span>
<span class="c">// - https://pkg.go.dev/sigs.k8s.io/controller-runtime@v0.14.1/pkg/reconcile</span>
<span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">PodSetReconciler</span><span class="p">)</span> <span class="n">Reconcile</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">log</span> <span class="o">:=</span> <span class="n">log</span><span class="o">.</span><span class="n">FromContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

	<span class="c">// TODO(user): your logic here</span>

	<span class="c">// listen to the creation of PodSet objects</span>

	<span class="c">// fetch the PodSet object</span>
	<span class="n">podset</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">batchv1</span><span class="o">.</span><span class="n">PodSet</span><span class="p">{}</span>
	<span class="n">err</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">TODO</span><span class="p">(),</span> <span class="n">req</span><span class="o">.</span><span class="n">NamespacedName</span><span class="p">,</span> <span class="n">podset</span><span class="p">)</span> <span class="c">// get the PodSet object from the API server by its name and namespace and store it in the podset variable</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">errors</span><span class="o">.</span><span class="n">IsNotFound</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="c">// Request object not found, could have been deleted after reconcile request.</span>
			<span class="c">// Owned objects are automatically garbage collected. For additional cleanup logic use finalizers.</span>
			<span class="c">// Return and don't requeue</span>
			<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{},</span> <span class="no">nil</span>
		<span class="p">}</span>
		<span class="c">// Error reading the object - requeue the request.</span>
		<span class="c">// If the error is not a NotFound error, the second if statement is triggered, and the controller</span>
		<span class="c">// returns a ctrl.Result{} along with the original error to requeue the request for reconciliation.</span>
		<span class="c">// This is done to allow the controller to retry the operation at a later time, in case the error was temporary or transient.</span>
		<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{},</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="n">podList</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">corev1</span><span class="o">.</span><span class="n">PodList</span><span class="p">{}</span> <span class="c">// create a new list of pods not podsets!</span>
	<span class="c">// The lbs variable is a map of labels that will be used to filter the list of pods. In this case, the labels are set to app=podset.Name and version=v0.1.</span>
	<span class="c">// This means that the query will only return pods that have the app label set to the name of the podset object and the version label set to v0.1.</span>
	<span class="n">lbs</span> <span class="o">:=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
		<span class="s">"app"</span><span class="o">:</span>     <span class="n">podset</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span>
		<span class="s">"version"</span><span class="o">:</span> <span class="s">"v0.1"</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="n">labelSelector</span> <span class="o">:=</span> <span class="n">labels</span><span class="o">.</span><span class="n">SelectorFromSet</span><span class="p">(</span><span class="n">lbs</span><span class="p">)</span> <span class="c">// create a label selector from the lbs map</span>
	<span class="c">// the listOps variable is a client.ListOptions object that contains the options for querying the Kubernetes API server.</span>
	<span class="n">listOps</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">.</span><span class="n">ListOptions</span><span class="p">{</span><span class="n">Namespace</span><span class="o">:</span> <span class="n">podset</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="n">LabelSelector</span><span class="o">:</span> <span class="n">labelSelector</span><span class="p">}</span> <span class="c">// create a list options object with the namespace and label selector</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">TODO</span><span class="p">(),</span> <span class="n">podList</span><span class="p">,</span> <span class="n">listOps</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{},</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="c">// Count the pods that are pending or running as available</span>
	<span class="k">var</span> <span class="n">available</span> <span class="p">[]</span><span class="n">corev1</span><span class="o">.</span><span class="n">Pod</span>
	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pod</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">podList</span><span class="o">.</span><span class="n">Items</span> <span class="p">{</span>
		<span class="c">// For each pod, it first checks whether the DeletionTimestamp field is set.</span>
		<span class="c">// If it is, this means that the pod is scheduled for deletion, and the code skips it</span>
		<span class="k">if</span> <span class="n">pod</span><span class="o">.</span><span class="n">ObjectMeta</span><span class="o">.</span><span class="n">DeletionTimestamp</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="k">continue</span>
		<span class="p">}</span>
		<span class="c">// If the pod is not scheduled for deletion, then check whether the pod's Status.Phase field is set to either corev1.PodRunning or corev1.PodPending.</span>
		<span class="c">// If the pod is in one of these states, it is considered available, and its reference is added to the available slice.</span>
		<span class="k">if</span> <span class="n">pod</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Phase</span> <span class="o">==</span> <span class="n">corev1</span><span class="o">.</span><span class="n">PodRunning</span> <span class="o">||</span> <span class="n">pod</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Phase</span> <span class="o">==</span> <span class="n">corev1</span><span class="o">.</span><span class="n">PodPending</span> <span class="p">{</span>
			<span class="n">available</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">available</span><span class="p">,</span> <span class="n">pod</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">numAvailable</span> <span class="o">:=</span> <span class="kt">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">available</span><span class="p">))</span> <span class="c">// get the number of available pods</span>

	<span class="c">// This code block creates a new slice of strings called availableNames,</span>
	<span class="c">// which contains the names of all the available pods returned by the previous code block.</span>
	<span class="n">availableNames</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{}</span>
	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pod</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">available</span> <span class="p">{</span>
		<span class="n">availableNames</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">availableNames</span><span class="p">,</span> <span class="n">pod</span><span class="o">.</span><span class="n">ObjectMeta</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c">// Update the status if necessary</span>
	<span class="n">status</span> <span class="o">:=</span> <span class="n">batchv1</span><span class="o">.</span><span class="n">PodSetStatus</span><span class="p">{</span>
		<span class="n">PodNames</span><span class="o">:</span>      <span class="n">availableNames</span><span class="p">,</span>
		<span class="n">ReadyReplicas</span><span class="o">:</span> <span class="n">numAvailable</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="c">// The code first checks whether the podset.Status field is equal to the new status value using the reflect.DeepEqual() function.</span>
	<span class="c">// If the two values are not equal, it means that the status value has been updated and needs to be written back to the Kubernetes API server.</span>
	<span class="k">if</span> <span class="o">!</span><span class="n">reflect</span><span class="o">.</span><span class="n">DeepEqual</span><span class="p">(</span><span class="n">podset</span><span class="o">.</span><span class="n">Status</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">podset</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">status</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">Status</span><span class="p">()</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">TODO</span><span class="p">(),</span> <span class="n">podset</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="n">log</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"Failed to update PodSet status"</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{},</span> <span class="n">err</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="n">numAvailable</span> <span class="o">==</span> <span class="n">podset</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">Replicas</span> <span class="p">{</span>
		<span class="c">// If the number of available pods is equal to the number of replicas specified in the podset.Spec.Replicas field,</span>
		<span class="c">// then the controller returns a ctrl.Result{} object without an error to indicate that the reconciliation is complete.</span>
		<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{},</span> <span class="no">nil</span>
	<span class="p">}</span>

	<span class="c">// Scale up or down</span>
	<span class="k">if</span> <span class="n">numAvailable</span> <span class="o">&gt;</span> <span class="n">podset</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">Replicas</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"Scaling down pods"</span><span class="p">,</span> <span class="s">"Currently available"</span><span class="p">,</span> <span class="n">numAvailable</span><span class="p">,</span> <span class="s">"Required replicas"</span><span class="p">,</span> <span class="n">podset</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">Replicas</span><span class="p">)</span>
		<span class="n">diff</span> <span class="o">:=</span> <span class="n">numAvailable</span> <span class="o">-</span> <span class="n">podset</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">Replicas</span>
		<span class="n">dpods</span> <span class="o">:=</span> <span class="n">available</span><span class="p">[</span><span class="o">:</span><span class="n">diff</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dpod</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">dpods</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">TODO</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">dpod</span><span class="p">)</span> <span class="c">// Writer interface --&gt; Create Delete Update ...</span>
			<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
				<span class="n">log</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"Failed to delete pod"</span><span class="p">,</span> <span class="s">"pod.name"</span><span class="p">,</span> <span class="n">dpod</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{},</span> <span class="n">err</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{</span><span class="n">Requeue</span><span class="o">:</span> <span class="no">true</span><span class="p">},</span> <span class="no">nil</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="n">numAvailable</span> <span class="o">&lt;</span> <span class="n">podset</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">Replicas</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"Scaling up pods"</span><span class="p">,</span> <span class="s">"Currently available"</span><span class="p">,</span> <span class="n">numAvailable</span><span class="p">,</span> <span class="s">"Required replicas"</span><span class="p">,</span> <span class="n">podset</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">Replicas</span><span class="p">)</span>
		<span class="c">// Define a new Pod object</span>
		<span class="n">pod</span> <span class="o">:=</span> <span class="n">newPodForCR</span><span class="p">(</span><span class="n">podset</span><span class="p">)</span>
		<span class="c">// Set PodSet instance as the owner and controller</span>
		<span class="c">// This ensures that the new pod is "owned" by the PodSet object and is managed by the controller.</span>
		<span class="c">// When a child object is created, it is important to set a reference to its owner object using the SetControllerReference function.</span>
		<span class="c">// This ensures that the owner object is set as the "controller" of the child object,</span>
		<span class="c">// which allows Kubernetes to automatically manage the child object's lifecycle and ensures that it is deleted when the owner object is deleted.</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">controllerutil</span><span class="o">.</span><span class="n">SetControllerReference</span><span class="p">(</span><span class="n">podset</span><span class="p">,</span> <span class="n">pod</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">Scheme</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{},</span> <span class="n">err</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">TODO</span><span class="p">(),</span> <span class="n">pod</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="n">log</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"Failed to create pod"</span><span class="p">,</span> <span class="s">"pod.name"</span><span class="p">,</span> <span class="n">pod</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{},</span> <span class="n">err</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{</span><span class="n">Requeue</span><span class="o">:</span> <span class="no">true</span><span class="p">},</span> <span class="no">nil</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{},</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="c">// TODO: Add a function called newPodForCR() that creates a new pod object for the podset object passed as an argument.</span>
<span class="c">// args: podset *batchv1.PodSet</span>
<span class="c">// newPodForCR returns a busybox pod with the same name/namespace as the cr</span>
<span class="k">func</span> <span class="n">newPodForCR</span><span class="p">(</span><span class="n">cr</span> <span class="o">*</span><span class="n">batchv1</span><span class="o">.</span><span class="n">PodSet</span><span class="p">)</span> <span class="o">*</span><span class="n">corev1</span><span class="o">.</span><span class="n">Pod</span> <span class="p">{</span>
	<span class="c">// creates a map of labels called labels, which contains two key-value pairs:</span>
	<span class="c">// app set to the name of the PodSet object, and version set to "v0.1".</span>
	<span class="c">// These labels are used to identify the pods created by the PodSet object.</span>
	<span class="n">labels</span> <span class="o">:=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
		<span class="s">"app"</span><span class="o">:</span>     <span class="n">cr</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span>
		<span class="s">"version"</span><span class="o">:</span> <span class="s">"v0.1"</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">corev1</span><span class="o">.</span><span class="n">Pod</span><span class="p">{</span>
		<span class="n">ObjectMeta</span><span class="o">:</span> <span class="n">metav1</span><span class="o">.</span><span class="n">ObjectMeta</span><span class="p">{</span>
			<span class="n">GenerateName</span><span class="o">:</span> <span class="n">cr</span><span class="o">.</span><span class="n">Name</span> <span class="o">+</span> <span class="s">"-pod-"</span><span class="p">,</span> <span class="c">// GenerateName is used to generate a unique name for the pod.</span>
			<span class="n">Namespace</span><span class="o">:</span>    <span class="n">cr</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span>
			<span class="n">Labels</span><span class="o">:</span>       <span class="n">labels</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="n">Spec</span><span class="o">:</span> <span class="n">corev1</span><span class="o">.</span><span class="n">PodSpec</span><span class="p">{</span>
			<span class="n">Containers</span><span class="o">:</span> <span class="p">[]</span><span class="n">corev1</span><span class="o">.</span><span class="n">Container</span><span class="p">{</span>
				<span class="p">{</span>
					<span class="n">Name</span><span class="o">:</span>    <span class="s">"busybox"</span><span class="p">,</span>
					<span class="n">Image</span><span class="o">:</span>   <span class="s">"busybox"</span><span class="p">,</span>
					<span class="n">Command</span><span class="o">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"sleep"</span><span class="p">,</span> <span class="s">"3600"</span><span class="p">},</span>
				<span class="p">},</span>
			<span class="p">},</span>
		<span class="p">},</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c">// SetupWithManager sets up the controller with the Manager.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">PodSetReconciler</span><span class="p">)</span> <span class="n">SetupWithManager</span><span class="p">(</span><span class="n">mgr</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Manager</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">NewControllerManagedBy</span><span class="p">(</span><span class="n">mgr</span><span class="p">)</span><span class="o">.</span>
		<span class="n">For</span><span class="p">(</span><span class="o">&amp;</span><span class="n">batchv1</span><span class="o">.</span><span class="n">PodSet</span><span class="p">{})</span><span class="o">.</span>
		<span class="n">Complete</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></div></div>]]></content><author><name></name></author><category term="notes"/><summary type="html"><![CDATA[Introduction about k8s operator and a sample code of a very simple controller.]]></summary></entry><entry><title type="html">CrimeMap</title><link href="https://zichengma.github.io/blog/2023/CrimemapUIUC/" rel="alternate" type="text/html" title="CrimeMap"/><published>2023-01-20T15:31:18+00:00</published><updated>2023-01-20T15:31:18+00:00</updated><id>https://zichengma.github.io/blog/2023/CrimemapUIUC</id><content type="html" xml:base="https://zichengma.github.io/blog/2023/CrimemapUIUC/"><![CDATA[<h1 id="cimemap">CimeMap</h1> <p><strong>MySQL, ReactJS, NodeJS, Full-stack application</strong></p> <p>We built a comprehensive database with records of past crimes occurring near UIUC, providing users with the ability to perform the standard Create, Read, Update, and Delete (CRUD) operations on the data through our web page. To further enhance the user experience, we integrated the Google Maps API, allowing users to view the crimes on a map and gain a better understanding of their relative locations. Our web page was created using ReactJS and NodeJS, while the database was implemented on a Google Cloud MySQL server, ensuring secure data storage and efficient retrieval.</p> <h2 id="showase-of-our-map">Showase of our map</h2> <p><strong><a href="https://youtu.be/-z2Pg80oAbs">Demo video</a> is avaliable on YouTube!!</strong></p> <p><strong><a href="https://github.com/ZichengMa/CrimeMapUIUC">Repo</a> is here! There is clear documentation in this repo</strong></p> <p><img src="Untitled.png" alt="First view of our website" width="850"/></p> <p>First view of our website</p> <p><img src="Untitled1.png" alt="The most creative component â€” Crime Map" width="850"/></p> <p>The most creative component â€” Crime Map</p>]]></content><author><name></name></author><category term="projects"/><summary type="html"><![CDATA[A full stack project, combined with MySQL database and ReactJS]]></summary></entry><entry><title type="html">ZinixOS</title><link href="https://zichengma.github.io/blog/2023/ZinixOS/" rel="alternate" type="text/html" title="ZinixOS"/><published>2023-01-17T15:18:10+00:00</published><updated>2023-01-17T15:18:10+00:00</updated><id>https://zichengma.github.io/blog/2023/ZinixOS</id><content type="html" xml:base="https://zichengma.github.io/blog/2023/ZinixOS/"><![CDATA[<h1 id="zinixos">ZinixOS</h1> <p>Our OS has been depolyed as an online appication. If you want to have have a try, please click the <a href="https://rong-hash.github.io/zinixos">link</a>.</p> <p><strong>C, x86 assembly, Operating System</strong></p> <p>This ambitious project is a Unix-like operating system built on the qemu virtual machine. It is the culmination of our operating system design course and is a testament to the hard work and dedication we put into this project. We developed this operating system from the ground up, ensuring that we could support a wide range of features and functionalities. We also added a number of unique features to make it stand out from other operating systems. Ultimately, this project was a great success and we are proud of the hard work and dedication we put into making it a reality. I also found great interest in operating system during this course</p> <ul> <li>Basic functionalities: Implemented an operating system supporting fundamental features such as scheduling, interrupts, system calls, exceptions, and file systems.</li> <li>Additionally, self-designed features were utilised to enhance the system, such as an implicit free list and slab cache to implement a virtual memory allocation system. Furthermore, advanced signals, speaker and hard-disk drivers were also implemented to the system, allowing for an increase in functionality and performance.</li> </ul> <h2 id="show-case-of-our-os">Show case of our OS</h2> <p>Two types of memory management</p> <ol> <li>Fixed length memory allocation</li> <li>Variable length memory allocation</li> </ol> <h3 id="fixed-length--slab-cache">Fixed length â€” Slab Cache</h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="n">this</span> <span class="n">specific</span> <span class="n">implementation</span><span class="p">,</span> <span class="n">fixed</span> <span class="n">length</span> <span class="n">memory</span> <span class="n">allocation</span> <span class="n">is</span> <span class="n">implemented</span> <span class="n">by</span> <span class="n">two</span> <span class="n">parts</span><span class="p">,</span> <span class="n">memory</span> <span class="n">management</span> <span class="n">unit</span> <span class="n">and</span> <span class="n">memory</span> <span class="n">unit</span><span class="p">.</span>
<span class="n">fixed</span> <span class="n">length</span> <span class="n">diagram</span><span class="o">:</span>
        <span class="o">|</span><span class="n">memory</span> <span class="n">management</span> <span class="n">unit</span><span class="o">|</span>  <span class="o">|</span><span class="n">memory</span> <span class="n">management</span> <span class="n">unit</span><span class="o">|</span>  <span class="o">|</span><span class="n">memory</span> <span class="n">management</span> <span class="n">unit</span><span class="o">|</span>  <span class="p">..........</span>    <span class="o">|</span><span class="n">memory</span> <span class="n">unit</span><span class="o">|</span>  <span class="o">|</span><span class="n">memory</span> <span class="n">unit</span><span class="o">|</span> <span class="o">|</span><span class="n">memory</span> <span class="n">unit</span><span class="o">|</span> <span class="p">.....</span>
        <span class="o">|</span><span class="n">next</span><span class="o">|</span>  <span class="o">---------------&gt;</span>  <span class="o">|</span><span class="n">next</span><span class="o">|</span>  <span class="o">---------------&gt;</span>  <span class="o">|</span><span class="n">next</span><span class="o">|</span>                                      <span class="err">â†‘</span>              <span class="err">â†‘</span>             <span class="err">â†‘</span>
        <span class="o">|</span><span class="n">ptr</span><span class="o">|---------------------|</span><span class="n">ptr</span><span class="o">|---------------------|</span><span class="n">ptr</span><span class="o">|---------------------------------------</span><span class="err">â†‘</span><span class="o">--------------</span><span class="err">â†‘</span><span class="o">-------------</span><span class="err">â†‘</span>
</code></pre></div></div> <p>Data structure: Linked list</p> <ul> <li>Slab_Create ( name , size )</li> <li>destroy , malloc , free</li> <li>Automatically shrinks and grows</li> <li>quick and fast to allocate and free</li> <li>granularity: 1byte - 4kB-8 bytes</li> </ul> <h3 id="variable-length--implicit-free-list">Variable length â€” Implicit free list</h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">On</span> <span class="n">the</span> <span class="n">other</span> <span class="n">hand</span><span class="p">,</span> <span class="n">variable</span> <span class="n">length</span> <span class="n">memory</span> <span class="n">allocation</span> <span class="n">is</span> <span class="n">implemented</span> <span class="n">very</span> <span class="n">similar</span> <span class="n">to</span> <span class="n">Linux</span><span class="err">'</span><span class="n">s</span> <span class="n">implicit</span> <span class="n">free</span> <span class="n">list</span> <span class="n">design</span><span class="p">.</span> 
<span class="n">A</span> <span class="n">memory</span> <span class="n">part</span> <span class="n">consists</span> <span class="n">of</span> <span class="n">two</span> <span class="n">parts</span><span class="p">,</span> <span class="n">memory</span> <span class="n">management</span> <span class="n">unit</span> <span class="n">and</span> <span class="n">real</span> <span class="n">useable</span> <span class="n">memory</span> <span class="n">unit</span><span class="p">.</span>
<span class="n">Memory</span> <span class="n">management</span> <span class="n">units</span> <span class="n">are</span> <span class="n">held</span> <span class="n">in</span> <span class="n">a</span> <span class="n">linked</span> <span class="n">list</span> <span class="n">to</span> <span class="n">track</span> <span class="n">each</span> <span class="n">memory</span> <span class="n">fragments</span> <span class="n">have</span> <span class="n">been</span> <span class="n">allocated</span><span class="p">.</span>
<span class="n">variable</span> <span class="n">length</span> <span class="n">diagram</span><span class="o">:</span>
        <span class="o">|</span><span class="n">memory</span> <span class="n">mangement</span> <span class="n">unit</span><span class="o">|</span> <span class="o">-&gt;</span> <span class="o">|</span><span class="n">memory</span> <span class="n">mangement</span> <span class="n">unit</span><span class="o">|</span> <span class="o">-&gt;</span> <span class="o">|</span><span class="n">memory</span> <span class="n">mangement</span> <span class="n">unit</span><span class="o">|</span> <span class="o">-&gt;</span> <span class="o">|</span><span class="n">memory</span> <span class="n">mangement</span> <span class="n">unit</span><span class="o">|</span>
        <span class="o">-----------------------</span>    <span class="o">-----------------------</span>    <span class="o">-----------------------</span>    <span class="o">-----------------------</span>
        <span class="o">|</span>                     <span class="o">|</span>    <span class="o">|</span>                     <span class="o">|</span>    <span class="o">|</span>                     <span class="o">|</span>    <span class="o">|</span>                     <span class="o">|</span>
        <span class="o">|</span>   <span class="n">useable</span> <span class="n">memory</span>    <span class="o">|</span>    <span class="o">|</span>   <span class="n">useable</span> <span class="n">memory</span>    <span class="o">|</span>    <span class="o">|</span>   <span class="n">useable</span> <span class="n">memory</span>    <span class="o">|</span>    <span class="o">|</span>   <span class="n">useable</span> <span class="n">memory</span>    <span class="o">|</span>
        <span class="o">|</span>                     <span class="o">|</span>    <span class="o">|</span>                     <span class="o">|</span>    <span class="o">-----------------------</span>    <span class="o">|</span>                     <span class="o">|</span>
        <span class="o">|</span>                     <span class="o">|</span>    <span class="o">-----------------------</span>                               <span class="o">-----------------------</span>
        <span class="o">|</span>                     <span class="o">|</span>
        <span class="o">-----------------------</span>

<span class="n">Slab</span> <span class="n">cache</span><span class="err">'</span><span class="n">s</span> <span class="n">implementation</span> <span class="n">is</span> <span class="n">based</span> <span class="n">on</span> <span class="n">fixed</span> <span class="n">length</span> <span class="n">memory</span> <span class="n">allocation</span><span class="p">.</span>
</code></pre></div></div> <p>Data structure: Implicit free list</p> <ul> <li>varmalloc( size )</li> <li>flexible: can allocate any size</li> <li>granularity: 1byte - 4MB</li> </ul> <p><img src="Untitled.png" alt="Memory allocation system and memory supevise system" style="zoom:50%;"/></p> <p>Memory allocation system and memory supevise system</p> <h2 id="signal">Signal</h2> <p>Support users to set handler they define</p> <p>Support sigreturn and set_handler syscall</p> <p>Support five signals:</p> <ol> <li>SIG_DIV_ZERO</li> <li>SIG_SEGFAULT</li> <li>SIG_INTERRUPT</li> <li>SIG_ALARM</li> <li>SIG_USER1</li> </ol> <p><img src="Untitled1.png" alt="signal tests for our signal implementation" style="zoom:50%;"/></p> <p>signal tests for our signal implementation</p> <h2 id="ata-hard-disk-support--file-system">ATA Hard Disk Support &amp; File System</h2> <ul> <li> <p>Writable file system</p> <div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">write</span> <span class="nx">fname</span> <span class="nx">contents</span>
</code></pre></div> </div> </li> <li> <p>Persistent Change (after reboot) by saving the change to the hard drive</p> </li> <li> <p>How the file system is loaded and initialized:</p> </li> </ul> <p><img src="Untitled2.png" alt="Untitled" style="zoom: 80%;"/></p> <h2 id="speaker-driver">Speaker Driver</h2> <p>Key mapping:</p> <p>(C3~E4) ZSXDCVGBHNJM,L.;/</p> <p>(C4~G5) Q2W3ER5T6Y7UI9O0P[=]</p> <p>Runs concurrently with any user programs &amp; across terminals</p> <p><img src="Untitled3.png" alt="part of the code for our â€˜keyboard pianoâ€™" style="zoom:50%;"/></p> <p>part of the code for our â€˜keyboard pianoâ€™</p>]]></content><author><name></name></author><category term="projects"/><summary type="html"><![CDATA[An operating system project from ECE391.]]></summary></entry><entry><title type="html">MedicalDB</title><link href="https://zichengma.github.io/blog/2023/MedicalDB/" rel="alternate" type="text/html" title="MedicalDB"/><published>2023-01-14T15:33:02+00:00</published><updated>2023-01-14T15:33:02+00:00</updated><id>https://zichengma.github.io/blog/2023/MedicalDB</id><content type="html" xml:base="https://zichengma.github.io/blog/2023/MedicalDB/"><![CDATA[<h1 id="medical-appointment-db">Medical Appointment DB</h1> <p><strong><em>B+ Tree, Hash Table, C++, UI</em></strong></p> <p>This database system is built to distribute medical appointments. We assume there are several hospitals and many patients. Every patient has certain properties used to identify their priority. Based on the priority and hospitalsâ€™ capacity, we will assign patients wisely.</p> <p>We used C++ to build a B+ Tree as the base for our database system. To make it more user-friendly, we implemented a UI instead of relying solely on terminal commands. Additionally, we imitated a SQL-style query language to make our system easier to learn for those familiar with SQL.</p> <h3 id="showcase-of-our-project">Showcase of our project</h3> <p><strong><a href="https://github.com/ZichengMa/CS225-DatabaseProject">Repo</a> is here !!!~~~</strong></p> <p><img src="Untitled.png" alt="Untitled" style="zoom: 67%;"/></p> <p><img src="Untitled1.png" alt="Untitled" style="zoom:67%;"/></p> <p><img src="Untitled2.png" alt="Untitled" style="zoom:67%;"/></p>]]></content><author><name></name></author><category term="projects"/><summary type="html"><![CDATA[Self-design database system based on B+Tree. Course project from CS225.]]></summary></entry><entry><title type="html">ECE391-MP3-Tutorial</title><link href="https://zichengma.github.io/blog/2023/ECE391-MP3-Tutorial/" rel="alternate" type="text/html" title="ECE391-MP3-Tutorial"/><published>2023-01-13T17:37:54+00:00</published><updated>2023-01-13T17:37:54+00:00</updated><id>https://zichengma.github.io/blog/2023/ECE391-MP3-Tutorial</id><content type="html" xml:base="https://zichengma.github.io/blog/2023/ECE391-MP3-Tutorial/"><![CDATA[<h1 id="ece391-mp3">ECE391 MP3</h1> <blockquote> <p><strong><em>Notes about all the documents and materials related to ECE391 MP3.</em></strong></p> </blockquote> <blockquote> <p><strong><em>FA22 Group 11 â€” ZinixOS</em></strong></p> </blockquote> <blockquote> <p>Mmebers: Zicheng Ma, Ziyuan Chen, Zhirong Chen, Shihua Zeng</p> </blockquote> <blockquote> <p>Language: ä¸­æ–‡+English</p> </blockquote> <p>FA22 ECE391æœ¬äººæœ€ç»ˆè¯„åˆ†A+ï¼Œä¾§é¢è¡¨æ˜è¿™ç¯‡æ–‡æ¡£åœ¨ä¸€å®šç¨‹åº¦ä¸Šè¿˜æ˜¯å¯ä»¥ä¿¡èµ–çš„ï¼Œè€Œä¸”æœ‰æˆ‘çš„é˜Ÿå‹å¯¹æ–‡æ¡£è¿›è¡ŒæŸ¥æ”¹å’Œè¡¥å……<del><em>ä½†å¦‚æœå†™å‡ºbugï¼Œæœ¬äººæ¦‚ä¸è´Ÿè´£</em></del> ğŸ¤£ ğŸ˜‹</p> <p>REFERENCE: OSdevç›¸å…³èµ„æ–™ï¼ŒTA Jerry Wangâ€™s slides</p> <h1 id="checkpoint-1">Checkpoint 1</h1> <h2 id="os-booting-gdt--idt-setup">OS Booting: GDT &amp; IDT Setup</h2> <h3 id="gdt">GDT</h3> <p>reference: <a href="https://wiki.osdev.org/Global_Descriptor_Table">https://wiki.osdev.org/Global_Descriptor_Table</a></p> <p>åœ¨<code class="language-plaintext highlighter-rouge">x86_desc.S</code>ä¸­åˆ›å»º<code class="language-plaintext highlighter-rouge">gdt_desc</code>æ ‡è®°ï¼ˆå‚è€ƒ<code class="language-plaintext highlighter-rouge">ldt_desc</code>ï¼‰</p> <ul> <li>48bytesï¼ŒåŒ…æ‹¬<code class="language-plaintext highlighter-rouge">.word</code>é•¿åº¦çš„limitå’Œ<code class="language-plaintext highlighter-rouge">.long</code>é•¿åº¦çš„base</li> </ul> <p>åœ¨<code class="language-plaintext highlighter-rouge">boot.S</code>ä¸­ç”¨<code class="language-plaintext highlighter-rouge">lgdt gdt_desc</code>è½½å…¥</p> <h3 id="idt">IDT</h3> <p>reference: <a href="https://wiki.osdev.org/Interrupt_Descriptor_Table">https://wiki.osdev.org/Interrupt_Descriptor_Table</a></p> <p>åœ¨<code class="language-plaintext highlighter-rouge">interrupt.c</code>ä¸­å®šä¹‰handlers</p> <ul> <li>å¯¹äºExceptionï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯+æ— é™å¾ªç¯ï¼ˆâ€œè“å±â€ï¼‰<strong>ï¼ˆåç»­ckptä¼šå¤„ç†å¦‚ä½•è·³å‡ºæ— é™å¾ªç¯ï¼‰</strong></li> <li>å¯¹äºInterruptï¼Œåœ¨å‡½æ•°ä½“ä¸­è°ƒç”¨linkage<strong>**</strong><strong>**</strong>ï¼ˆæ— å‚æ•°ï¼‰<strong>**</strong><strong>**</strong>ï¼Œåœ¨asmä¸­å®šä¹‰linkageå‡½æ•°ï¼ˆPush all, call handler, pop all, <strong>**</strong><strong>iret</strong><strong>**</strong>ï¼‰ <ul> <li>éœ€è¦è°ƒç”¨linkageçš„åŸå› æ˜¯ï¼ŒC functionåœ¨ç»“æŸåé»˜è®¤ä½¿ç”¨retï¼Œè€Œinterruptç»“æŸåéœ€è¦ä»kernelè·³å›åˆ°user spaceï¼Œä½¿ç”¨çš„æ˜¯iretã€‚åˆ©ç”¨asm linkageæ¥å®Œæˆè¿™ä¸€æ­¥è·³è½¬ï¼Œç”¨C functionæ¥å®Œæˆæ¯ä¸ªinterrupt handlerçš„å…·ä½“å·¥ä½œã€‚</li> </ul> </li> <li>åˆ©ç”¨å®šä¹‰å¥½çš„SET_IDT_ENTRYæ¥è®¾ç½®IDTä¸­æŒ‡å‘çš„linkage/function</li> </ul> <h2 id="device-and-interrupt">Device and Interrupt</h2> <hr/> <h3 id="pic">PIC</h3> <p>reference:<a href="https://wiki.osdev.org/PIC">https://wiki.osdev.org/PIC</a></p> <p>PICæ‰€ä½¿ç”¨portä½ç½®</p> <p><img src="Untitled.png" alt="" width="250"/></p> <p>åœ¨IDTä¸­ï¼ŒPIC_MASTERä½¿ç”¨<strong>0x20-0x27</strong> vectorå‘¼å«handlerï¼ŒPIC_SLAVEä½¿ç”¨<strong>0x28-0x2F</strong>å‘¼å«handler</p> <p>PIC_SLAVEé“¾æ¥åˆ°PIC_MASTERçš„<strong>2å·vector</strong></p> <p><strong><em>Initialization:</em></strong></p> <ol> <li>maskæ‰æ‰€æœ‰interruptï¼ˆå‘data portä¼ å…¥0xffï¼‰</li> <li>å…ˆç»™äºˆ0x11 commandï¼Œç„¶åPICä¼šç­‰å¾…æ¥ä¸‹æ¥3ä¸ªä¼ å…¥å‚æ•°è¿›è¡Œåˆå§‹åŒ–ï¼ˆICW1)</li> <li>æ¥ä¸‹æ¥ç¡®å®šåœ¨IDTä¸­çš„ä½ç½®(ICW2)</li> <li>å†³å®šMasterå’ŒSlaveçš„cascadeçŠ¶å†µ(ICW3)</li> <li>æœ€åå‘Data portä¼ å…¥è¿™æ˜¯x86æ¨¡å¼ï¼Œä»¥é€‚é…x86æ¨¡å¼è¿›è¡Œå·¥ä½œ</li> </ol> <p>ä¸»è¦å¯¹ç€Lecture10 PPTå†™å³å¯</p> <hr/> <p><strong><em>enable_irq / disable_irq:</em></strong></p> <p>PICå†…éƒ¨å­˜åœ¨ä¸€ä¸ªregister Interrupt Mask Registerï¼Œå…±8bitï¼Œå½“å¯¹åº”bitä½è¢«setä¸º1æ—¶ï¼ŒPICä¼šå¿½ç•¥å¯¹åº”ä½ç½®irqã€‚æ³¨æ„: maskæ•°å­—é«˜çš„irqä¸ä¼šå½±å“æ•°å­—ä½çš„irqï¼ˆpriorityæ›´é«˜çš„irqï¼‰</p> <p>å…ˆåˆ¤æ–­irqæ˜¯å¦è¶…è¿‡7ï¼Œè‹¥è¶…è¿‡7ï¼Œå‘PIC_SLAVEçš„data portä¼ å…¥æ•°æ®ï¼Œå¦åˆ™å‘PIC_MASTERdata portä¼ å…¥æ•°æ®</p> <p><img src="Untitled1.png" alt="" width="320"/> <img src="Untitled2.png" alt="" width="320"/></p> <hr/> <p><strong><em>send_EOI:</em></strong></p> <p>åŒæ ·éœ€è¦æ£€æŸ¥irq numberã€‚æ— è®ºå¦‚ä½•éƒ½è¦ç»™MASTER command port send EOIï¼Œå¦‚æœæ˜¯SLAVEçš„handlerç»“æŸï¼Œé‚£å°±ç»™SLAVEä¹Ÿè¡¥ä¸Š</p> <p>æ³¨æ„: æˆ‘ä»¬çš„ä»£ç ä¸­EOIåœ¨sendä¹‹å‰éœ€è¦å’Œirqåšä¸€ä¸ªORæ“ä½œï¼Œä»¥å‘ŠçŸ¥PICæ˜¯å“ªä¸€ä¸ªirqç»“æŸ</p> <p><img src="Untitled3.png" alt="Untitled" width="320"/></p> <p>è¡¥å……ï¼šä»¥ä¸Šå‡½æ•°å‡éœ€è¦åš<strong>sanity check</strong>ï¼Œä¸å…è®¸ä¼ å…¥çš„irq numberæ˜¯ä¸€ä¸ª0-15ä»¥å¤–çš„æ•°å€¼</p> <hr/> <h3 id="rtc">RTC</h3> <p>RTCå¯ä»¥ä»¥å¤šä¸ªé¢‘ç‡è¿è¡Œï¼ŒåŸºç¡€é¢‘ç‡32.768kHzï¼Œå¯ä»¥ç”¨divider registeræ”¹å˜ï¼Œä½†æ˜¯ä¸è¦å˜ï¼Œè¦ä¸ç„¶ä¸å‡†ã€‚å¯¹äºinterruptï¼Œé»˜è®¤äº§ç”Ÿinterruptçš„é¢‘ç‡æ˜¯1024Hzï¼Œå¯ä»¥è‡ªè¡Œä¿®æ”¹ï¼Œthe RTC can theoretically generate <strong>15 interrupt rates between 2 Hz and 32768 Hz (</strong>2^1-2^15)</p> <p>RTC handleræœŸé—´ï¼Œç¦ç”¨NMIï¼Œå¦åˆ™å¯¼è‡´RTCå˜æˆä¸å¯ç”¨çŠ¶æ€</p> <p>RTCä½¿ç”¨<strong>port 0x70å’Œ0x71</strong>ï¼Œ0x70ç”¨æ¥æŒ‡ç¤ºç”¨å“ªä¸ªregisterï¼Œ0x71åŒ…å«æ•°æ®ã€‚åœ¨é€‰æ‹©registeræ—¶å¯ä»¥é¡ºå¸¦maskæ‰NMI</p> <p><img src="Untitled4.png" alt="Untitled" width="750"/></p> <hr/> <p><strong><em>Initialization:</em></strong></p> <ol> <li>æ‰“å¼€IRQ8 è¿™é‡ŒresetåŸå› æ˜¯æ¯æ¬¡è¯»å†™å®Œä¹‹åï¼Œport 0x70çš„å†…å®¹éƒ½ä¼šè¢«æ¸…é›¶ï¼Œéœ€è¦é‡æ–°æŒ‡å®šregisterï¼Œç„¶ååœ¨è¿™ä¹‹åè¦<code class="language-plaintext highlighter-rouge">enable_irq(8)</code></li> </ol> <p><img src="Untitled5.png" alt="Untitled" width="750"/></p> <ol> <li> <p>é€‰æ‹©interruptäº§ç”Ÿçš„frequency</p> <p>å¯„å­˜å™¨Açš„ä½4ä½ï¼Œæ˜¯divider valueï¼Œé»˜è®¤ä½0110å³6ï¼Œæ‰€ä»¥é»˜è®¤frequency = 2^15Â»(6-1) = 1024</p> <p>è®¾ç½®å¥½å¯„å­˜å™¨Açš„ä½4ä½(ç§°ä¸ºrate)åï¼Œæœ€ç»ˆ<strong>frequency = 2^15Â Â»(rate-1)</strong></p> <p><strong>rateæœ€ä½åªèƒ½é€‰3</strong>ï¼Œä½äº3ä¼šroll overï¼Œå¯¼è‡´interrupté¢‘ç‡ä¸å‡†</p> <p><img src="Untitled6.png" alt="Untitled" width="750"/></p> </li> </ol> <hr/> <p><strong><em>handler:</em></strong></p> <p>éœ€è¦ä½¿ç”¨ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå¹¶ä¸”éœ€è¦volatileï¼Œæ¥è®°å½•RTCäº§ç”Ÿinterruptçš„æ¬¡æ•°ï¼Œå½“åšæ—¶é’Ÿ</p> <p>è¿™ä¸ªæ•°å­—ï¼Œé™¤ä»¥frequencyï¼Œå°±å¯ä»¥å¾—åˆ°å½“å‰è¿‡äº†å¤šå°‘ç§’ï¼Œæˆ–è€…å¤šå°‘ms</p> <ol> <li> <p><strong>if register C is not read after an IRQ 8, then the interrupt will not happen again</strong></p> <p>åœ¨æ¯æ¬¡handlerä¹‹åéœ€è¦åŠ å…¥ä¸€æ®µ</p> <p><img src="Untitled7.png" alt="Untitled"/></p> </li> <li> <p>ç„¶åsend_EOIï¼ŒSTI</p> </li> </ol> <hr/> <h3 id="keyboard">Keyboard</h3> <p>é”®ç›˜æœ¬èº«å±äºPS/2 controllerï¼Œä½¿ç”¨PS/2çš„portã€‚è¯»å–é”®ç›˜å†…å®¹ä»<strong>0x60</strong>ç«¯å£è·å¾—ï¼Œ<strong>connect to irq1</strong></p> <p><img src="Untitled8.png" alt="Untitled"/></p> <p>commandä¸ºä¸€ä¸ªbyteï¼Œé”®ç›˜ä¼šresponse â€œACKâ€ (to acknowledge the command) or a â€œResendâ€ (to say something was wrong with the previous command)</p> <p>scan code setä¼šè¡¨ç¤ºå“ªä¸ªé”®è¢«ä¸‹å‹ã€‚scan codeå¯èƒ½ä¸æ­¢ä¸€ä¸ªï¼Œæœ€å¤š6ä¸ªbytesã€‚å½“keyboardçŠ¶æ€æœºçŸ¥é“ç°åœ¨scan codeå·²ç»å…¨éƒ¨è·å–äº†ï¼Œå°±å¯ä»¥å°†å…¶è½¬åŒ–æˆkey codeäº†ã€‚</p> <p>æˆ‘ä»¬çš„é”®ç›˜å±äºUS QWERTYï¼Œç”¨SCAN CODE SET1</p> <p><strong><em>Initialization:</em></strong></p> <p>åªéœ€è¦enable_irqå³å¯</p> <p><strong><em>handler:</em></strong></p> <ol> <li>ä»portä¸­è¯»å–æ•°æ® <code class="language-plaintext highlighter-rouge">inb(0x60)</code></li> <li>åˆ©ç”¨æå‰å»ºå¥½çš„tableå¯¹åº”ASCII <ol> <li>æ£€æµ‹æ˜¯å¦ä¸ºç‰¹æ®Šé”® shift capsâ€¦. å¦‚æœæ˜¯ï¼Œæš‚æ—¶ä¸åšä»»ä½•æ“ä½œï¼ˆæˆ–è€…å¯ä»¥åœ¨è¿™ä¸ªckptå°±æŠŠè¿™ä¸ªä¸œè¥¿å¼„å¥½ï¼‰</li> <li>å¯¹æ™®é€šé”®ï¼Œå¯¹åº”ASCIIç å¹¶putc</li> </ol> </li> <li>send EOI</li> </ol> <h2 id="paging">Paging</h2> <p>reference: <a href="https://wiki.osdev.org/Paging">https://wiki.osdev.org/Paging</a></p> <h3 id="kernelc">kernel.c</h3> <p>åœ¨ <code class="language-plaintext highlighter-rouge">kernel.c</code> çš„ <code class="language-plaintext highlighter-rouge">entry</code>å‡½æ•°ä¸­æ·»åŠ  <code class="language-plaintext highlighter-rouge">page_init</code>å‡½æ•°ï¼Œ è°ƒç”¨ <code class="language-plaintext highlighter-rouge">page.c</code>ä¸­åˆå§‹åŒ–åˆ†é¡µçš„ä»£ç </p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Init the PIC */</span>
	<span class="n">i8259_init</span><span class="p">();</span>

<span class="cm">/* Init paging */</span>
	<span class="n">page_init</span><span class="p">();</span>
</code></pre></div></div> <h3 id="pagec-pageh">page.c, page.h</h3> <ol> <li>åœ¨æ–°æ–‡ä»¶ <code class="language-plaintext highlighter-rouge">page.h</code> ä»¥åŠ <code class="language-plaintext highlighter-rouge">page.c</code> ä¸­å®šä¹‰ç›¸å…³å‡½æ•°å’Œæ•°æ®ç»“æ„ <ul> <li>page tableéœ€è¦è‡ªå®šä¹‰æ•°æ®ç»“æ„ï¼Œå‚ç…§OSdevæˆ–è€…x86æ‰‹å†Œ</li> </ul> </li> <li>å®šä¹‰å‡½æ•° <ul> <li>éœ€è¦å®Œæˆå¯¹ <strong>page directory table</strong> å’Œ ä¸¤ä¸ª <strong>page table</strong> çš„åˆå§‹åŒ–ï¼Œå¹¶ä¸”å†™å…¥å†…å­˜ä¸­å¯¹åº”ä½ç½®ã€‚page initéƒ¨åˆ†å®é™…ä¸Šå°±æ˜¯ä¿®æ”¹åˆ›å»ºå¥½çš„page tablesä¸­å„ä¸ªbitçš„å€¼ï¼Œå¯¹åº”æ‰€éœ€è¦å¼€å¯çš„pagingéƒ¨åˆ†</li> <li>éœ€è¦æ“ä½œ CPU çš„ <code class="language-plaintext highlighter-rouge">cr0</code>, <code class="language-plaintext highlighter-rouge">cr3</code>, <code class="language-plaintext highlighter-rouge">cr4</code> å¯„å­˜å™¨ï¼Œå‘ŠçŸ¥ç¡¬ä»¶page directoryçš„ä½ç½®å¹¶ä¸º paging å¼€å¯ç¡¬ä»¶æ”¯æŒã€‚è¿™ä¸€æ­¥ç›¸å½“äºæ¿€æ´»ä¸Šé¢ä¸€æ­¥åˆå§‹åŒ–å¥½çš„page directoryå’Œpage table</li> <li>cr0ç”¨äºå¼€å¯paging cr4ç”¨äºå¼€å¯4MB page cr3ä¸ºTLBï¼Œå³æŒ‡ç¤ºpage directoryä½ç½®</li> </ul> <p>page directory entry å’Œ page table entry çš„ç»“æ„ï¼š</p> <p><img src="Untitled9.png" alt="Untitled"/></p> </li> </ol> <h1 id="checkpoint-2">Checkpoint 2</h1> <h2 id="terminal-driver">Terminal Driver</h2> <hr/> <p>ToDo:</p> <ol> <li>å®Œå–„é”®ç›˜æ˜ å°„ï¼šShiftã€CapsLockï¼ˆCtrlå’ŒAltä¹Ÿéœ€è¦ç”¨å…¨å±€å˜é‡è¿½è¸ªï¼Œæš‚æ—¶æ²¡æœ‰æ›´å¤šä½œç”¨â€”â€”TAï¼‰</li> <li>å…‰æ ‡è¿½è¸ªï¼šè®©æ‰“çš„å­—å‡ºç°åœ¨å…‰æ ‡å¤„ï¼Œéœ€è¦æ”¯æŒä¸Šä¸‹æ»‘åŠ¨ï¼ˆå…¶å®åªæœ‰å‘ä¸Šï¼›å¯ä»¥ä¸ç”¨ä¿ç•™command historyï¼‰ã€‚è¿˜éœ€è¦æ”¯æŒCtrl+L/Ctrl+lçš„æ¸…å±æ“ä½œ</li> <li>è¿˜éœ€è¦æ”¯æŒé€€æ ¼é”®ï¼ˆç›´æ¥æ”¹å˜å…‰æ ‡ï¼‰å’Œè¡Œç¼“å†²è¾“å…¥ï¼Œç¼“å†²åŒºå¤§å°128B</li> </ol> <p><strong>read:</strong></p> <p>ä»keyboard bufferä¸­è¯»å–å†™å…¥çš„å­—ç¬¦ï¼Œè½¬ç§»åˆ°terminal bufferä¸­ï¼Œè¿”å›è¯»å–çš„bytesæ€»æ•°</p> <p>è®¾ç½®whileå¾ªç¯ï¼Œä¸æ–­é€šè¿‡é”®ç›˜å‘keyboard bufferä¸­å¢åŠ å†…å®¹ï¼Œæ‰«æåˆ°enteræ‰è¿”å›ã€‚ç¼“å†²åŒºæ¢å…¥127ä¸ªå­—ç¬¦æ—¶ï¼Œæ‹’ç»æ–°è¿›å…¥çš„å­—ç¬¦ï¼ˆåœæ­¢æ›´æ–°ç¼“å†²åŒºï¼‰ï¼Œç­‰å¾…ä¸€ä¸ªenterçš„è¾“å…¥ã€‚ï¼ˆæœ€åä¸€ä¸ªå­—ç¬¦åº”ä¸º\nï¼‰</p> <p>å¯¹äºterminalï¼Œreadå¤šå°‘å­—ç¬¦ï¼Œå°±æŠŠbufferä¸­çš„å¤šå°‘ä¸ªå­—ç¬¦ç»™æ¸…ç©ºï¼Œå¹¶å°†åé¢çš„æŒªåŠ¨åˆ°å‰é¢æ¥</p> <p>^ å…¶å®å¯ä»¥ç›´æ¥è¦†å†™</p> <p>readæœ‰ä¸¤ç§æƒ…å†µä¼šç»ˆæ­¢ï¼Œç¬¬ä¸€ç§æ˜¯readåˆ°æŒ‡å®šbyteæ•°ç›®ï¼Œç¬¬äºŒç§æ˜¯ç¢°åˆ°äº†\nï¼ˆå…¶å®åªæœ‰ä¸€ç§ï¼Ÿï¼‰</p> <p>^ åªåœ¨è¯»åˆ°\næ—¶è¿”å›å³å¯ï¼Œè¶Šç•Œæ—¶ç›´æ¥å¿½ç•¥åé¢çš„å­—ç¬¦</p> <p><strong>write:</strong></p> <p>ä»ä¼ å…¥çš„bufä¸­è¯»å–æ‰€æœ‰å†…å®¹ï¼Œè½¬ç§»åˆ°å±å¹•ä¸Šï¼Œè¿”å›written bytesæ•°ç›®æˆ–è€…-1</p> <p><strong>æ³¨æ„éœ€è¦æ»šåŠ¨æ¢è¡Œâ†“çš„æƒ…å†µï¼šæ‰“å°å­—ç¬¦è®¡æ•°è¾¾åˆ°80æ—¶è§¦å‘scrollingå‡½æ•°</strong></p> <p><strong>scrolling:</strong></p> <p>å¯èƒ½è¦ä¿®æ”¹putcå‡½æ•°ï¼Œå°†ä¸Šæ–¹æ‰€æœ‰å†…å®¹å‘ä¸Šç§»åŠ¨ä¸€è¡Œï¼ŒæŠŠæœ€åº•ä¸‹ä¸€è¡Œæ¸…ç©ºï¼Œç„¶åå†æ‰“å°æ–°çš„å­—ç¬¦ï¼ˆç›´æ¥æ›´æ–°vmemï¼‰</p> <p><strong>clear:</strong></p> <p>lib.cä¸­çš„clearå‡½æ•°åªæœ‰æ¸…ç†video memoryçš„æ“ä½œï¼Œæ²¡æœ‰é‡ç½®ä¸‹ä¸€ä¸ªcharacteråº”è¯¥å‡ºç°çš„ä½ç½®</p> <p>â†‘ä½†ä»ç„¶æ˜¯å¥½äº‹ï¼Œå·®ç‚¹å°±è¦å†™å¾ªç¯å¾€vmemé‡Œèµ‹é›¶äº†ï¼ˆï¼‰</p> <h2 id="read-only-file-system">Read-only File system</h2> <hr/> <p>ToDo:</p> <ol> <li>open and read a file system image</li> <li>copy program images into physical memory</li> </ol> <h3 id="åŸºæœ¬æ•°æ®ç»“æ„">åŸºæœ¬æ•°æ®ç»“æ„</h3> <p>æ¯ä¸ªBlock 4kBï¼Œç¬¬ä¸€ä¸ªblockç§°ä¸ºboot blockï¼ŒåŒ…å«file systemçš„æ•´ä½“ç»Ÿè®¡ä¿¡æ¯ï¼ˆdiræ•°é‡ã€inodeæ•°é‡ã€æ•°æ®å—æ•°é‡ï¼‰å’Œæ‰€æœ‰çš„directoryã€‚ç»Ÿè®¡ä¿¡æ¯ã€æ¯ä¸ªdirectoryå‡å æ®64B</p> <p>ç¬¬ä¸€ä¸ªdirectoryæ€»æ˜¯ä»£è¡¨å½“å‰directoryï¼Œå‘½åä¸º.ï¼ˆä¸€ä¸ªç‚¹ï¼‰ï¼Œæ‰€ä»¥å®é™…ä¸Šæœ€å¤šåªèƒ½æœ‰62ä¸ªå…¶ä»–files</p> <p>æ¯ä¸€ä¸ªdirectoryåŒ…å«ï¼š32Bæ–‡ä»¶åï¼ˆä¸ä¸€å®šè¦åŒ…å«EOSï¼Œä¹Ÿå³æœªå¿…æœ‰â€\0â€æ ‡è®°å­—ç¬¦ä¸²å°¾ï¼‰ã€4Bæ–‡ä»¶ç±»å‹ã€4B inodeç´¢å¼•</p> <p><img src="Untitled10.png" alt="Untitled" width="850"/></p> <p>file type 0 ä»£è¡¨user levelå¯ä»¥è§¦ç¢°çš„RTCï¼Œ1 for directoryï¼Œ2 for regular fileã€‚å¯¹äºRTCå’Œdirectoryï¼Œ#inodeæ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚</p> <p><img src="Untitled11.png" alt="Untitled" width="650"/></p> <p>ä»¥ä¸Šä¸‰ä¸ªå‡½æ•°éƒ½æ˜¯å¤±è´¥return -1ï¼ˆfnameä¸å­˜åœ¨/indexä¸åˆæ³•/#inodeä¸åˆæ³•/inodeä¸­æ•°æ®å—ç´¢å¼•ä¸åˆæ³•ï¼‰ã€‚å‰ä¸¤ä¸ªå‡½æ•°æˆåŠŸéƒ½ä¼šå°†dentryæŒ‡é’ˆèµ‹å€¼æˆæ‰€éœ€è¦çš„é‚£ä¸ªdirectoryæ•°æ®ï¼Œç¬¬ä¸‰ä¸ªå‡½æ•°ç›¸å½“äºâ€œreadâ€è¿™ä¸€system callï¼Œè¿”å›è¯»å–äº†å¤šå°‘ä¸ªbyte</p> <hr/> <p><strong>ä¸Taskçš„è”åŠ¨ï¼š</strong></p> <p>æ¯ä¸€ä¸ªtaskæœ€å¤šå¼€å¯8ä¸ªfileï¼Œå®ƒä»¬è¢«å­˜åœ¨ä¸€ä¸ªfile arrayä¸­ï¼Œè€Œfile descriptorå°±æ˜¯ç”¨æ¥åœ¨arrayä¸­æ‰¾å¯»è¿™äº›fileçš„ã€‚file arrayä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½åº”è¯¥å‚¨å­˜ä»¥ä¸‹å››ç§ä¿¡æ¯</p> <ol> <li>å¯¹åº”è¿™ä¸ªfileçš„å„ç§æ“ä½œå‡½æ•°ï¼Œ<strong>open, read, write, and close</strong> to perform type-specific actions for each operation.</li> <li>inode numberï¼Œå¯¹äºdirectoryæˆ–è€…RTCå°±æ˜¯0</li> <li>file positionï¼ŒæŒ‡ç¤ºç”¨æˆ·åœ¨ä»€ä¹ˆä½ç½®å¼€å¯äº†è¿™ä¸ªfileï¼Œç”±read system callæ›´æ–°</li> <li>flagï¼Œç”¨æ¥æŒ‡ç¤ºå½“å‰descriptoræ­£åœ¨ä½¿ç”¨</li> </ol> <p><img src="Untitled12.png" alt="Untitled" width="850"/></p> <p>open a fileçš„æµç¨‹ï¼šå‚¨å­˜å¯¹åº”çš„jump table pointerï¼Œå°†flagè®¾ç½®æˆin-use</p> <hr/> <h3 id="filesystem_init">filesystem_init</h3> <ol> <li> <p>æ‰¾åˆ°File imgçš„å¼€å¤´åœ°å€ï¼ŒFileçš„æ‰€æœ‰ä¿¡æ¯åœ¨bootçš„æ—¶å€™å°±å·²ç»å¸®æˆ‘ä»¬å‚¨å­˜åœ¨äº†å†…å­˜çš„æŸä¸€ä¸ªåœ°æ–¹</p> <p>æ ¹æ®æ–‡æ¡£ï¼Œæ¯ä¸€ä¸ªimgéƒ½ç®—æ˜¯ä¸€ä¸ªmoduleï¼Œå¯ä»¥loadè¿›å»</p> <p><img src="Untitled.jpeg" alt="Untitled" width="750"/></p> <p><img src="Untitled13.png" alt="Untitled" width="650"/></p> </li> <li>åœ¨<code class="language-plaintext highlighter-rouge">kernel.c</code>é‡Œè¿›è¡Œfile systemåˆå§‹åŒ–ï¼Œå°†ä¸Šé¢æ‰¾åˆ°çš„æŒ‡é’ˆä¼ é€’ç»™file system</li> <li>ä¼ å…¥çš„åœ°å€æ˜¯boot_blcokçš„å¼€å¤´ï¼Œç›´æ¥å°†ä¸€ä¸ªå…¨å±€å˜é‡boot_block_ptræŒ‡å‘è¿™ä¸ªåœ°æ–¹</li> <li>boot_blockä¸­çš„3ä¸ªnumä¿¡æ¯ï¼Œèµ‹å€¼ç»™3ä¸ªå…¨å±€å˜é‡ï¼Œç”¨äºå‚¨å­˜æœ‰å¤šå°‘ä¸ªdirectoryï¼Œæœ‰å¤šå°‘ä¸ªinodeï¼Œæœ‰å¤šå°‘ä¸ªdata_block</li> <li>æ ¹æ®å„ä¸ªæ•°å­—ï¼Œæ‰¾åˆ°inodeçš„å¼€å¤´å’Œdata_blockçš„å¼€å¤´ï¼Œå¹¶å°†è¿™ä¸¤ä¸ªåœ°å€å‚¨å­˜åœ¨å¦å¤–ä¸¤ä¸ªpträ¸­ï¼Œä»¥å¤‡åç»­ä½¿ç”¨</li> </ol> <p>tipsï¼šå› ä¸ºæ–‡ä»¶ç³»ç»Ÿåªè¯»ä¸å†™ï¼Œå¯ä»¥ç”¨é™æ€çš„å…¨å±€å˜é‡å‚¨å­˜è¿™äº›æ‰€æœ‰ä¿¡æ¯</p> <hr/> <h3 id="three-base-functions">Three base functions</h3> <p><strong>read_dentry_by_index:</strong></p> <ol> <li>sanity checkï¼Œå¦‚æœindexè¶…å‡ºdir_numï¼Œreturn -1</li> <li>å°†boot_blockä¸­çš„<code class="language-plaintext highlighter-rouge">dentries[index]</code>å€¼èµ‹ç»™ä¼ å…¥çš„dentryæŒ‡é’ˆ <ol> <li>èµ‹å€¼è¿‡ç¨‹ä¸­ï¼Œfilenameå¿…é¡»ç”¨<code class="language-plaintext highlighter-rouge">lib.c</code>æä¾›çš„<code class="language-plaintext highlighter-rouge">strncpy</code>ï¼Œå› ä¸ºfilenameå…è®¸æ²¡æœ‰stringç»“å°¾ç¬¦<code class="language-plaintext highlighter-rouge">\0</code></li> </ol> </li> </ol> <p><strong>read_dentry_by_name:</strong></p> <ol> <li>è®¾ç½®ä¸€ä¸ªindexå˜é‡ï¼Œéå†æ‰€æœ‰åœ¨boot_blockçš„file nameï¼Œæ¯æ¬¡index++</li> <li>index++ä¹‹ååšcheckï¼Œå¦‚æœå·²ç»è¶…å‡ºdir_numï¼Œreturn -1</li> <li>å¦‚æœåŒ¹é…åˆ°ï¼ˆåˆ©ç”¨<code class="language-plaintext highlighter-rouge">lib.c</code>ä¸­æä¾›çš„<code class="language-plaintext highlighter-rouge">strncmp</code>ï¼‰ï¼Œå‘¼å«<code class="language-plaintext highlighter-rouge">read_dentry_by_index(index, dentry)</code>ï¼Œè®©read_dentry_by_indexå®ŒæˆçœŸæ­£çš„èµ‹å€¼æ“ä½œ</li> </ol> <p><strong>read_data:</strong></p> <ol> <li>sanity checkï¼Œç¡®è®¤(fileæ€»é•¿åº¦-offset)&gt;0 å¹¶ä¸” inode_index &lt; boot_blockæ‹¥æœ‰çš„inodeæ•°ç›®-1</li> <li>æ‰¾åˆ°å¯¹åº”çš„inodeï¼Œ<code class="language-plaintext highlighter-rouge">inodes_arr[i]</code></li> <li>è®¡ç®—éœ€è¦ä»å“ªä¸ªdata_blockçš„å“ªä¸ªä½ç½®å¼€å§‹è¯»å– offset / block_size + offset % block_size</li> <li>è®¡ç®—è¯»å–åˆ°å“ªä¸ªdata_blockçš„å“ªä¸ªä½ç½®</li> <li>å¼€å§‹å¾ªç¯å¤åˆ¶æ•°æ®åˆ°buffä¸­ï¼ŒåŒæ—¶è¦æ£€æµ‹æ˜¯å¦éœ€è¦æ›´æ¢å¦ä¸€ä¸ªdata_block</li> </ol> <hr/> <p>é—®é¢˜ï¼šæˆ‘ä»¬éœ€è¦åœ¨è¿™é‡Œå®ç°file descriptor arrayå—ï¼Ÿæš‚æ—¶ä¸éœ€è¦ï¼Œåœ¨ä¹‹åçš„scheduleréƒ¨åˆ†å‡ºç°äº†task structå†å®ç°</p> <hr/> <h2 id="the-real-time-clock-driver">The Real-Time Clock Driver</h2> <p>reference:<a href="https://wiki.osdev.org/RTC">https://wiki.osdev.org/RTC</a></p> <p>åšåˆ°å’ŒRTCäº¤äº’ï¼Œè®©userç›´æ¥ä¿®æ”¹å®ƒçš„é¢‘ç‡ï¼Œæœ€å¥½èƒ½<strong>è™šæ‹ŸåŒ–</strong></p> <p>è™šæ‹ŸåŒ–å¯ä»¥é‡‡ç”¨ä¸€ä¸ªå…¨å±€å˜é‡counterï¼Œæ¯æ¬¡interruptäº§ç”Ÿéƒ½++ï¼Œè¿™é‡Œçš„interruptçœ‹åšæ˜¯ä¸€ä¸ªåŸºç¡€interruptï¼Œé‡‡å–æœ€é«˜é¢‘ç‡ï¼Œå³1024Hz</p> <p>å¯¹äºä¸åŒé¢‘ç‡ï¼Œå¦‚æœcounterè‡ªè¿™ä¸ªreadå‡½æ•°è¢«åˆ›å»ºåè¿‡äº† 1024/frequencyæ¬¡ï¼Œåˆ™return</p> <p>ä¾‹å¦‚ï¼šè™šæ‹ŸåŒ–çš„RTC_readéœ€è¦ä¸€ä¸ª512Hzçš„RTCï¼Œé‚£ä¹ˆè¿‡äº†1024/512=2ä¸ªinterruptåreturn</p> <p>å¯èƒ½éœ€è¦ä¸€ä¸ªarrayï¼Œå…¨éƒ¨entriesåˆå§‹åŒ–ä¸º1ï¼Œå¯¹ä¸åŒçš„è™šæ‹Ÿçš„RTC deviceå‚¨å­˜å„è‡ªçš„é¢‘ç‡ï¼Œinterruptå®é™…ä¸Šåªæ”¹å˜counterã€‚åœ¨åç»­ckptä¸­ï¼Œæœ‰å¤šä¸ªterminalï¼Œæ¯ä¸€ä¸ªterminalä¸Šæ‰§è¡Œçš„ç¨‹åºå¯èƒ½ä¼šè®¾ç½®ä¸åŒçš„RTCé¢‘ç‡ï¼Œå¯¹åº”è¿™ä¸ªarrayä¸­çš„ä¸€ä¸ªfreq</p> <p><strong>open:</strong></p> <p>å°†freqæ”¹ä¸º2Hzï¼Œè¿”å›0ã€‚flagè®¾ç½®ä¸º0ã€‚åç»­åˆ°äº†å¤šè¿›ç¨‹æ—¶ï¼Œfreqå’Œflagéƒ½æœ‰å¤šä¸ªï¼Œæ¯ä¸ªè¿›ç¨‹å¯¹åº”ä¸€å¯¹freqå’Œflagã€‚</p> <p><strong>close:</strong></p> <p>è¿”å›0ï¼ˆæ–‡æ¡£å¦‚æ­¤ï¼‰</p> <p><strong>read:</strong></p> <p>è·Ÿè¸ªå…¨å±€flagï¼Œç”¨ä¸€ä¸ªwhile loopè®©readå‡½æ•°é™·å…¥å¾ªç¯ï¼Œç›´åˆ°flagè¢«è®¾ç½®æˆ1ï¼Œè·³å‡ºå¾ªç¯ã€‚è·³å‡ºæ—¶å†é‡æ–°å°†flagè®¾ç½®ä¸º0ï¼Œreturnã€‚è¿™æ ·å¯ä»¥è¾¾åˆ°ä¸€ç§ç±»ä¼¼äºlinuxä¸­sleepçš„æ•ˆæœã€‚</p> <p><strong>write:</strong></p> <p>å…ˆåšsanity checkï¼Œå¦‚æœéƒ½é€šè¿‡ï¼Œæ ¹æ®ä¼ å…¥çš„frequencyè®¾ç½®freqã€‚æ­¤æ—¶æš‚æ—¶åªæœ‰ä¸€ä¸ªterminalï¼Œæ²¡æœ‰è¿›ç¨‹ä¹‹é—´çš„åˆ‡æ¢ï¼Œåœ¨åç»­ckptä¸­éœ€è¦æ£€æŸ¥å½“å‰writeæŒ‡ä»¤æ˜¯ç”±å“ªä¸€ä¸ªè¿›ç¨‹è°ƒç”¨çš„ï¼Œä¿®æ”¹è¿™ä¸ªè¿›ç¨‹å¯¹åº”çš„freq</p> <p><strong>handler:</strong></p> <p>ä½¿counter++ï¼Œæ£€æŸ¥æ˜¯å¦åº¦è¿‡äº†freqä¸ªå•ä½æ—¶é—´ï¼Œå¦‚æœæ˜¯ï¼Œå°†flagè®¾ç½®ä¸º1ã€‚è®¾ç½®ä¸º1çš„æ—¶å€™ï¼Œä¹‹å‰æŸæ¬¡è°ƒç”¨çš„readå‡½æ•°å°±ä¼šè¿”å›ã€‚</p> <p>å…·ä½“ç›¸å…³ç«¯å£ï¼Œå¯¹rtcçš„äº¤äº’è¯·æŸ¥çœ‹referenceï¼ˆOSdevï¼‰</p> <hr/> <h1 id="checkpoint-3">Checkpoint 3</h1> <h2 id="system-calls">System Calls</h2> <p>int $0x80å‘¼å«ï¼Œæœ€å¤šæ¥å—ä¸‰ä¸ªå‚æ•°</p> <p>call number, arg1, arg2, arg3 â†’ EAX, EBX, ECX, EDX</p> <p>æˆåŠŸreturn 0ï¼Œå¤±è´¥return -1ï¼Œè¿”å›å€¼æ”¾åœ¨EAX</p> <p>ä¸€éƒ¨åˆ†ä¸ä¼šè¿”å›ï¼ˆå¦‚haltï¼‰</p> <p><strong>open</strong></p> <p>åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ‰¾åˆ°æ–‡ä»¶ï¼Œåˆ†é…ä¸€ä¸ªç©ºé—²çš„æè¿°ç¬¦å¹¶åˆå§‹åŒ–ï¼ˆæ³¨æ„æ–‡ä»¶ç±»å‹ï¼‰</p> <p><strong>close</strong></p> <p>æ£€æµ‹æè¿°ç¬¦åˆæ³•æ€§ï¼Œåé‡Šæ”¾æè¿°ç¬¦</p> <p><strong>read</strong></p> <p>ä»RTC/é”®ç›˜/æ–‡ä»¶/ç›®å½•è¯»å–æ•°æ®ï¼Œè¿”å›è¯»å–çš„bytesæ•°é‡</p> <p>RTCï¼šæ¥æ”¶åˆ°virtual interruptæ—¶è¿”å›0</p> <p>é”®ç›˜ï¼šè¯»å–åˆ°\næ—¶ æˆ– bufferæ»¡æ—¶è¿”å›</p> <p>æ–‡ä»¶ï¼šè¯»å–åˆ°EOFæ—¶ æˆ– bufferæ»¡æ—¶è¿”å›</p> <p>File PositionæŒ‡è¯»å–ä½ç½®</p> <p>system callçš„ä¼ å…¥å‚æ•°æ€§è´¨ä¹Ÿå†³å®šäº†æˆ‘ä»¬éœ€è¦ä¸ºå®ƒä»¬ç¼–å†™ä¸€ä¸ªwrapper(link)æ¥ä¿è¯å‚æ•°æ­£å¸¸ä¼ é€’</p> <hr/> <h3 id="wrapper--linkage">Wrapper &amp; Linkage</h3> <p>éœ€è¦å®ç°çš„10ä¸ªsystem callæœ€å¤šåªæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œç”¨asmå†™wrapper <strong>ï¼ˆè¿™éƒ¨åˆ†å¹¶ä¸å½’æˆ‘ä»¬å†™ï¼Œæä¾›çš„å¯æ‰§è¡Œæ–‡ä»¶åŒ…å«äº†è¿™éƒ¨åˆ†wrapperï¼‰</strong></p> <p>åœ¨IDTçš„0x80å·ä½ç½®è°ƒç”¨åŒ…è£…å‡½æ•°</p> <ol> <li>callee saved</li> <li>è·å–argumentsï¼Œæ ¹æ®æ•°ç›®ä¸åŒä»EBX, ECX, EDXä¸­è·å–</li> <li>è·å–system call numberï¼Œ<code class="language-plaintext highlighter-rouge">int 0x80</code></li> <li>restore callee saved</li> </ol> <hr/> <h3 id="system-call-handler">System call handler</h3> <ol> <li>save all registers</li> <li>check system call number is valid or not</li> <li> <p>åˆ©ç”¨å·²æœ‰çš„function tableæ‰¾åˆ°å¯¹åº”system callï¼Œä»callä¹‹åçš„stackæ¥çœ‹ï¼Œè·å–å‚æ•°åº”è¯¥åœ¨æ¯ä¸€ä¸ªsystem callæ‰€å¯¹åº”çš„å‡½æ•°ä¹‹å†… â€” é—®é¢˜ï¼šå¦‚ä½•è®©ä¸€ä¸ªC functionç›´æ¥ä»å¯„å­˜å™¨ä¸­è¯»å–æ•°å€¼ï¼Œfastcallï¼Ÿ</p> <p>æˆ–è€…<strong>å¦ä¸€ç§è§£å†³åŠæ³•ï¼Œç›´æ¥åœ¨system call handlerä¸­æ¢å¤C convention</strong></p> <p><img src="Untitled14.png" alt="Untitled"/></p> </li> <li>æ£€æŸ¥è¿”å›å€¼ï¼Œå¤±è´¥ä¸æˆåŠŸ</li> <li>restore register</li> <li>é‡æ–°è®¾ç½®å…³äºiretæ‰€éœ€è¦çš„ä¸€åˆ‡</li> <li>iret</li> </ol> <hr/> <h3 id="execute-sys-callå…·ä½“æµç¨‹">Execute sys callå…·ä½“æµç¨‹</h3> <p>å°è¯•åŠ è½½ä¸€ä¸ªæ–°çš„ç¨‹åº</p> <p>æ¥æ”¶å‚æ•°commandï¼ˆå­—ç¬¦ä¸²ï¼‰æ˜¯ä¸€ä¸ªä»¥ç©ºæ ¼ä¸ºåˆ†ç•Œçš„ä¸€è¿ä¸²wordsï¼Œç¬¬ä¸€ä¸ªwordæ˜¯file nameï¼Œä¹‹åçš„éƒ½ç”±getargsè·å¾—</p> <p>æ— æ³•æ‰§è¡Œï¼ˆå‘½ä»¤ä¸å­˜åœ¨ã€éå¯æ‰§è¡Œæ–‡ä»¶ï¼‰è¿”å›-1ï¼ŒExceptionè¿”å›256ï¼Œhaltè¿”å›0~255çš„å€¼</p> <p><strong>Parse args</strong></p> <p>å¯¹äº<strong>file name</strong>ï¼Œç›´æ¥å–å‡ºç¬¬ä¸€ä¸ªç©ºæ ¼ä¹‹å‰çš„æ‰€æœ‰å†…å®¹å³å¯ï¼Œå†™ä¸€ä¸ªloopï¼Œç›´åˆ°char == â€™ â€™åœæ­¢</p> <p>å…¶ä»–çš„argumentsæš‚æ—¶å¥½åƒç”¨ä¸åˆ°</p> <p><strong>Check file validity</strong></p> <ol> <li>åˆ©ç”¨file nameæ£€æŸ¥fileä¸­æ˜¯å¦å­˜åœ¨ä¸€æ ·çš„æ–‡ä»¶ï¼Œåœ¨è¿™é‡Œåˆ©ç”¨<strong>read_dentry_by_name</strong>æ—¶å¯ä»¥æŠŠä¿¡æ¯å­˜åœ¨ä¸€ä¸ªdentryå˜é‡ä¸­ï¼Œæ¥ä¸‹æ¥éœ€è¦ä½¿ç”¨</li> <li>å†è¯»å–è¿™ä¸ªfileçš„å‰4ä¸ªbytesï¼ˆ<strong>read_data</strong>ï¼‰ï¼ŒæŸ¥çœ‹å®ƒæ˜¯å¦æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶</li> <li>åœ¨è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥è·å–programç¬¬ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œçš„ä½ç½®ï¼ˆ<strong>read_data</strong>ï¼‰ï¼Œå‚¨å­˜åœ¨å¯æ‰§è¡Œæ–‡ä»¶çš„24-27bytes</li> </ol> <p><strong>Create PCBs</strong></p> <p>å¯»æ‰¾åˆ°pidï¼Œå½“å‰æ˜¯ç¬¬å‡ ä¸ªprocess</p> <p>ä¸ºPCBåˆ†é…ç©ºé—´ï¼Œåˆå§‹åŒ–ï¼Œè®¾ç½®ä¸ºactiveï¼Œå…¶ä¸­kernel stackæ ¹æ®ä¸åŒçš„pidæœ‰ä¸åŒçš„å€¼</p> <p>Open File descriptor for stdin/stdout</p> <p><strong>Set up paging</strong></p> <p>éœ€è¦çŸ¥é“å½“å‰æ˜¯ç¬¬å‡ ä¸ªprocessï¼Œæˆ‘ä»¬åº”è¯¥å¯ä»¥å‡è®¾æœ€å¤šåªæœ‰3ä¸ªprocessï¼ˆåƒPPTä¸Šä¸€æ ·ï¼‰</p> <p>ç›´æ¥åœ¨Page Directoryä¸­ ( 0x8000000(128MB)Â Â»22 )ï¼Œå³2^5=<strong>32ä½ç½®ä¿®æ”¹æ˜ å°„</strong></p> <p><strong>phy add = 0x800000 + pid*4MB</strong> å°† PD[32]å¯¹åº”çš„4MB pageèµ·å§‹ç‚¹ä¿®æ”¹ä¸º <strong>phy addÂ Â»12</strong>å³å¯</p> <p>è®°å¾—flush tlbï¼Œå³é‡æ–°è½½å…¥ä¸€écr3</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 *   set_user_prog_page
 *   Set page for a user program
 *   input: pid -- the pid of the user program
 *   output: None
 *   side effect: Change the paging directory; Change CR3; flush TLB
 */</span>
</code></pre></div></div> <p><strong>Load file(program) into memory</strong></p> <p>fileçš„èµ·å§‹ç‚¹ä¸ºUSER_CODE 0x8048000</p> <p><strong>Prepare for context switch</strong></p> <p>mp3 systemä¸­åªæœ‰ä¸€ä¸ªtssï¼Œå°±æ˜¯åœ¨<code class="language-plaintext highlighter-rouge">x86_desc.h</code>ä¸­çš„tsså˜é‡ï¼Œåœ¨å›åˆ°user levelä¹‹å‰ï¼Œtssä¸­çš„ç›¸å…³å‚æ•°éœ€è¦è¢«æ›´æ–°</p> <p>ä¸éœ€è¦è€ƒè™‘scheduleçš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦æ›´æ”¹tssçš„å€¼å³å¯ï¼Œåœ¨soft multitaskingä¸­ï¼Œtssåªæœ‰ä¸¤ä¸ªå€¼æ˜¯ç›¸å…³çš„ï¼Œ<strong>æ›´æ”¹SS0ä¸ºkernel dsï¼ŒESP0ä¸ºå½“å‰processçš„stackï¼Œå³8MB-8KB*(pid)-1ä¸ªbyteã€</strong></p> <aside> â¡ï¸ esp0æ°¸è¿œæ˜¯8MB-8KB*(pid)-1ï¼Œæ˜¯å› ä¸ºæ¯æ¬¡ä»kernelå›åˆ°user spaceï¼Œkernel stackéƒ½è¢«â€œæ¸…ç©ºâ€ï¼Œstackä¸Šå®é™…çš„æ•°æ®æ²¡æœ‰æ”¹å˜ï¼Œä½†ä¸‹ä¸€æ¬¡å›åˆ°kernel spaceï¼Œä»æ ˆåº•å¼€å§‹ã€‚è¿™æ ·åšçš„åŸå› æ˜¯é˜²æ­¢kernel stack overflow </aside> <p><img src="Untitled15.png" alt="Untitled"/></p> <p>iretéœ€è¦çš„äº”ä¸ªå‚æ•°ï¼š</p> <ul> <li>user dsï¼Œç›´æ¥ç”¨x86_desc.hä¸­çš„user dsï¼›</li> <li>espï¼Œuser stackï¼Œä½äº128MB-132MBè¿™ä¸€æ®µmemoryçš„æœ«å°¾ï¼Œå³132MB-4byteï¼›</li> <li>eflagï¼Œç›´æ¥æŠŠå½“å‰çš„flag pushè¿›å»å¯è¡Œå—ï¼Ÿ</li> <li>csï¼Œtssä¸­çš„user csï¼›</li> <li>eipï¼ŒæŠŠä¸Šé¢å‚¨å­˜çš„user programç¬¬ä¸€æ¡æŒ‡ä»¤å¯¹åº”çš„åœ°å€æ‹¿è¿‡æ¥</li> </ul> <hr/> <h3 id="halt-sys-callå…·ä½“æµ">Halt sys callå…·ä½“æµ</h3> <p>ç»ˆæ­¢è¿›ç¨‹å¹¶è¿”å›æ¯è¿›ç¨‹</p> <p>Shell â€”â€executeâ€ syscall (when cmd is typed)â†’ Program</p> <p>Program â€”â€haltâ€ syscall (when â€œreturnâ€)â†’ Shell</p> <p>å¾ˆé‡è¦çš„ä¸€ç‚¹ï¼Œå¦‚æœæˆ‘ä»¬è¦æ£€æµ‹æ˜¯å¦exceptionï¼Œéœ€è¦åœ¨åŸæ¥çš„exception while1æ”¹æˆå‘¼å«haltçš„å‡½æ•°</p> <p>haltçš„æ€»ä½“æ€æƒ³ï¼Œåˆ©ç”¨parent processåœ¨kernel stackä¸Šå­˜å¥½çš„contextæ¥iretï¼Œä»¥æ­¤å›åˆ°parent processçš„user level</p> <ol> <li>é¦–å…ˆcheckè¿™æ˜¯å¦æ˜¯exceptionå‘¼å«çš„</li> <li>å†çœ‹ä¸€ä¸‹æ˜¯å¦æ˜¯shellï¼Œå¦‚æœæ˜¯shellæœ¬èº«å‡ºé—®é¢˜ï¼Œéœ€è¦é‡å¯shellï¼Œå› ä¸ºå®ƒæ˜¯ç¬¬ä¸€ä¸ªprogramï¼Œä¸èƒ½è¢«å®Œå…¨æ€æ­»</li> <li>å…³é—­file descriptorï¼Œå°†å¼€å¯äº†çš„fileå‡å…³é—­ï¼Œå› ä¸ºå¦‚æœä¸å…³é—­ï¼Œä¹‹åé‡æ–°åˆ©ç”¨è¿™æ®µpcbçš„æ—¶å€™ä¼šå‘ç°è®¸å¤šfileéƒ½æ˜¯â€œå¼€å¯â€çŠ¶æ€</li> <li>å°†å½“å‰çš„processè®¾ç½®ä¸ºnon-active</li> <li>æ‰¾åˆ°parentï¼Œå¹¶ä»parentçš„pcbä¸­å–å‡ºä¿¡æ¯ï¼Œå°†pagingè®¾ç½®ä¸ºparent programæ‰€éœ€è¦çš„</li> <li>å°†tssæ›´æ–°æˆparentçš„ä¿¡æ¯ï¼ŒSS0=kernel dsï¼ŒESP0=parent kernel stack</li> <li>å†ä»parent pcbä¸­æ‰¾åˆ°ä¹‹å‰çš„contextä¿¡æ¯ï¼Œå…·ä½“è€Œè¨€ï¼Œæ˜¯ä»parent pcbä¸­é‡æ–°å–å›ä¹‹å‰çš„ebpå’Œespï¼Œä¹‹åå†leave+retå°±ç›¸å½“äºä»executeè¿™ä¸ªsyscallçš„åœ°æ–¹è¿”å›ï¼Œç›´æ¥ç”¨è¿™äº›contextä¿¡æ¯æ¥è¿›è¡Œiret</li> </ol> <hr/> <h2 id="tasks">Tasks</h2> <p>æ­¤æ¬¡ä¸ç”¨å®Œæˆschedulerï¼Œä½†éœ€è¦åœ¨æŸä¸€ä¸ªprogramäº§ç”Ÿexceptionæ—¶å›åˆ°shell</p> <p>æ‰€æœ‰taskså…±äº«ä¸€ä¸ª4MBå†…æ ¸æ€åˆ†é¡µã€‚å¯¹äºä¸€ä¸ªè€Œè¨€ï¼Œå…¶taskæ˜ åƒï¼ˆä»£ç ï¼‰çš„ç‰©ç†åœ°å€æ˜¯å›ºå®šçš„è€Œä¸”æ¯ä¸ªå°äº4MBï¼Œåˆ†é…ä¸€ä¸ªç”¨æˆ·æ€åˆ†é¡µå³å¯ã€‚</p> <hr/> <h2 id="loader">Loader</h2> <p>åœ¨æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ä¸­ï¼Œå°†ç¨‹åºä»£ç ä»éšæœºåˆ†é…&amp;æ’åˆ—ï¼ˆä¹Ÿå³åˆ†æ•£ï¼‰çš„4kB disk blocksæ‹·è´åˆ°è¿ç»­çš„ç‰©ç†åœ°å€ä¸­</p> <p>æ³¨æ„ç»´æŠ¤æ ˆï¼Œæ‹·è´åœ¨å†…æ ¸æ€æ‰§è¡Œï¼Œæ‹·è´ç»“æŸåè¦å›åˆ°ç”¨æˆ·æ€</p> <hr/> <h2 id="executing-user-level-code">Executing User-level Code</h2> <p>æ³¨æ„å†…æ ¸æ€ç¨‹åºä¸èƒ½è°ƒç”¨ç”¨æˆ·æ€ç¨‹åºï¼Œè¦å®ç°privilege switch</p> <p>IRETçš„æ­£å¸¸è¿è¡Œè¦æ±‚æä¾›ESP EIP EFLAGS CS SSç­‰å¯„å­˜å™¨å€¼</p> <p>EIP â†’ ä½äºå¯æ‰§è¡Œæ–‡ä»¶24~27Bçš„entry point</p> <p>ESP â†’ è½½å…¥å¯æ‰§è¡Œæ–‡ä»¶çš„4MBåˆ†é¡µæœ«å°¾</p> <p>CS â†’ user code segment</p> <p>DS â†’ user data segment</p> <p>SS â†’ user stack segment ï¼ˆæœ‰å£°æ˜å—ï¼Ÿï¼‰</p> <p>è€Œä¸”éœ€æ”¹å˜TSS</p> <hr/> <h2 id="process-control-block">Process Control Block</h2> <p>éœ€å‚¨å­˜çš„Per-Task StateåŒ…æ‹¬</p> <p>File arrayï¼ˆè®°å½•å¼€å¯çš„æ–‡ä»¶ï¼‰</p> <p>Signal information â†’ extra creditå†…å®¹ï¼Œå¯ä»¥ä¸è¯†é—²</p> <p>Kernel stackï¼ˆæ¯ä¸ª8kBï¼‰</p> <p>ä¸¤ä¸ªtaskçš„kernel stackåˆ†åˆ«å ç”¨ç¬¬4080~4087ã€4088~4095kB</p> <p>parent pid</p> <p>excute_ebp / excute_esp ç”¨äºhalt</p> <hr/> <h1 id="checkpoint-4">Checkpoint 4</h1> <h2 id="getargs">getargs</h2> <p>åœ¨executeå†…è°ƒç”¨</p> <p>å‚æ•°ï¼ˆä»¥å­—ç¬¦ä¸²çš„å½¢å¼ï¼‰å­˜å‚¨åœ¨PCBï¼Œè£å‰ªï¼ˆå¤´éƒ¨ï¼‰å¯æ‰§è¡Œæ–‡ä»¶å&amp;ç©ºæ ¼ã€ï¼ˆå°¾éƒ¨ï¼‰ç©ºæ ¼</p> <p>ä¾‹ï¼šåœ¨Shell #0ä¸­è¿è¡Œâ€ cat arg1 arg2 â€œï¼Œå°†â€arg1 arg2â€å­˜å…¥PCB #1ï¼ˆæ³¨æ„ç©ºæ ¼æ•°é‡ï¼‰</p> <h3 id="æ­¥éª¤">æ­¥éª¤</h3> <p>åœ¨bufä¸­ä¼ å…¥ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤</p> <p>æ£€æµ‹å¤´éƒ¨ç©ºæ ¼ç»“æŸçš„ä½ç½®ã€å°¾éƒ¨ç©ºæ ¼å¼€å§‹çš„ä½ç½®</p> <p>å°†ä¸¤ä¸ªä½ç½®ä¹‹é—´çš„argså­—ç¬¦ä¸²æ‹·è´è¿›PCBï¼ˆargsä¹‹é—´å¯ä»¥æœ‰ä»»æ„æ•°é‡ç©ºæ ¼ï¼Œäº¤ç»™user programå¤„ç†ï¼‰</p> <p>æˆåŠŸè¿”å›0ï¼Œå¤±è´¥ï¼ˆargs+NULLå¤ªå¤§/æ£€æµ‹ä¸åˆ°argsï¼‰è¿”å›-1</p> <p>æœ€å¥½æŠŠPCB #0ï¼ˆshellï¼‰çš„argså­—ç¬¦ä¸²è®¾ç½®ä¸ºâ€\0â€</p> <h2 id="vidmap">vidmap</h2> <p>éœ€è¦DPL = 0ä»¥è®¿é—®ç‰©ç†å†…å­˜vmemï¼Œå½±å“å®‰å…¨æ€§ã€‚è§£å†³æ–¹æ¡ˆä¸ºå°†vmemæ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜</p> <p>*screen_startæŒ‡å‘è™šæ‹Ÿå†…å­˜åœ°å€ï¼ˆç”¨æˆ·ç»™å®šï¼‰</p> <p>åŒé‡æŒ‡é’ˆçš„ä½œç”¨æ˜¯å…è®¸è®¿é—®æ•´ä¸ªæ–°çš„4kB page</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// implimentation</span>
<span class="kt">uint8_t</span><span class="o">*</span> <span class="n">screen_start</span> <span class="o">=</span> <span class="n">vidmap</span><span class="p">();</span>
<span class="c1">// or</span>
<span class="n">uint_t</span><span class="o">*</span> <span class="n">screen_start</span><span class="p">;</span>
<span class="n">vidmap</span><span class="p">(</span><span class="n">screen_start</span><span class="p">);</span>
</code></pre></div></div> <h3 id="æ­¥éª¤-1">æ­¥éª¤</h3> <p>æ£€æŸ¥*screen_startçš„åˆæ³•æ€§ï¼šåº”å¤§äº128MBï¼Œå°äº132MBï¼ˆï¼Ÿï¼‰</p> <p>ä¿®æ”¹PDå’ŒPTå®ç°mappingï¼Œå°†DPLè®¾ç½®ä¸º3ä¾›ç”¨æˆ·è®¿é—®ï¼ˆï¼Ÿï¼‰</p> <p>æˆåŠŸè¿”å›<strong>0xB8000</strong>ï¼Œå¤±è´¥è¿”å›-1</p> <hr/> <h1 id="checkpoint-5">Checkpoint 5</h1> <h2 id="multiple-terminals">Multiple Terminals</h2> <p>3ä¸ªterminalï¼Œæœ€å¤šåŒæ—¶è¿è¡Œ6ä¸ªç¨‹åº</p> <h3 id="initialization">Initialization</h3> <ul> <li>Initial bootup: åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å°±åˆå§‹åŒ–ä¸‰ä¸ªè¿›ç¨‹</li> <li>After bootup: ç”¨Alt+F1/F2/F3åˆ‡æ¢ï¼Œå½“ç”¨æˆ·ç¬¬ä¸€æ¬¡æŒ‰ä¸‹ALT+F2/F3æ—¶å¼€å¯æ–°çš„terminal</li> </ul> <h3 id="separate-io-buffer">Separate I/O buffer</h3> <p>æ¯ä¸€ä¸ªterminalç»“æ„ä½“ä¸­å­˜å‚¨ç‹¬ç«‹çš„I/O bufferã€å…‰æ ‡ã€æ˜¾ç¤ºå±ä¸Šçš„æ–‡å­—ã€active flag</p> <p>åœ¨åˆ‡æ¢å‡ºterminalçš„æ—¶å€™å­˜èµ·æ¥ï¼Œåˆ‡æ¢å›æ¥çš„æ—¶å€™é‡æ–°è½½å…¥</p> <h3 id="isolation">Isolation</h3> <p>é€€å‡ºæŸä¸€ä¸ªterminalçš„shellæ—¶ï¼Œä¸ä¼šç«‹å³é‡å¯ï¼Œç›´åˆ°æŠŠæœ€åä¸€ä¸ªshellä¹Ÿé€€å‡ºæ—¶æ‰éœ€è¦é‡å¯shell</p> <p>åœ¨haltä¿®æ”¹ä¸€ä¸‹é‡å¯æ¡ä»¶ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªshell</p> <h3 id="switch">Switch</h3> <p><img src="Untitled16.png" alt="multi terminal å†…å­˜ç¤ºæ„å›¾" width="850"/></p> <p>multi terminal å†…å­˜ç¤ºæ„å›¾</p> <p>éœ€è¦æ–°åˆ†é…ä¸‰å—backup video memoryï¼Œç±»ä¼¼build bufferçš„ä½œç”¨ï¼Œæ¯ä¸€å—éƒ½å‚¨å­˜ç€å½“å‰terminalçš„video memoryï¼Œåœ¨åˆ‡æ¢çš„æ—¶å€™è¿›è¡Œè½½å…¥</p> <h3 id="æ­¥éª¤-2">æ­¥éª¤</h3> <p>åœ¨<code class="language-plaintext highlighter-rouge">terminal.c</code>ä¸­å®šä¹‰<code class="language-plaintext highlighter-rouge">void switch_terminal(uint8_t term_index)</code>å‡½æ•°ï¼Œåœ¨<code class="language-plaintext highlighter-rouge">keyboard.c</code>ä¸­è°ƒç”¨</p> <ol> <li>Sanity checkï¼Œä¼ å…¥indexæ˜¯å¦è¶Šç•Œ</li> <li>åˆ¤æ–­term_indexæ˜¯å¦ä¸ºå½“å‰current_term_indexï¼ˆå…¨å±€å˜é‡ï¼‰ï¼Œè‹¥æ˜¯åˆ™ç›´æ¥è¿”å›</li> <li>åˆ‡æ¢æµç¨‹(ä»¥ä»terminal1åˆ‡æ¢åˆ°terminal2ä¸ºä¾‹å­) <ol> <li>video mapåˆ°current terminalï¼Œå³è®©0xB8000æŒ‡å‘phyiscalçš„0xB8000</li> <li>å°†å½“å‰vmemå­˜åˆ°å±äºterminal1çš„backupå†…å­˜å—ï¼ˆterm1 video pageï¼‰ä¸­</li> <li>å°†terminal2çš„backupå†…å­˜å—è½½å…¥vmem</li> <li>è®¾ç½®å…‰æ ‡ä½ç½®ï¼Œæ­¤æ—¶å±å¹•æ›´æ–°å®Œæˆ</li> <li>æ›´æ–°å…¨å±€å˜é‡current_term_id</li> <li>video mapåˆ°å½“å‰æ­£åœ¨scheduleçš„process</li> </ol> </li> </ol> <p>tips: video mapæŒ‡çš„æ˜¯æ›´æ–°virtual 0xB8000æŒ‡å‘çš„physical memoryæ˜ å°„å…³ç³»ï¼Œä»¥ä¸‹ä¸ºå‡½æ•°çš„æè¿°</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*   remap_vidmap_page
 *   Set page for video memory for a specific terminal.
 *   If terminal_id = active one, directly write into physical memory.
 *   If terminal_id != active one, map user video memory to corresponding backup buffer.
 *   input: screen_start -- starting address of the video memory
 *   output: None
 *   side effect: Change the paging directory; Change CR3; flush TLB */</span>
</code></pre></div></div> <hr/> <h2 id="scheduling">Scheduling</h2> <p>è·Ÿè¸ªæ‰€æœ‰æ´»è·ƒçš„taskï¼Œæ¯éš”10-50msè½®æµåˆ‡æ¢æ‰§è¡Œ</p> <p>è¢«æš‚åœçš„taskä¸åº”è¯¥æ‰“å°ä¿¡æ¯ï¼Œéœ€è¦åŠ¨æ€æ›´æ–°page tableä»¥å°†æ˜¾ç¤ºæ˜ å°„åˆ°0xB8000ä»¥å¤–çš„åœ°æ–¹</p> <h3 id="pit">PIT</h3> <p>reference: <a href="https://wiki.osdev.org/PIT">OSDEV Link for PIT</a></p> <p>Schedulingä¸­è®¡æ—¶ä½¿ç”¨PITè€ŒéRTCï¼Œå› ä¸ºRTCçš„ä¼˜å…ˆçº§å¤ªä½äº†</p> <p>åœ¨PITå‘ç”Ÿä¸€æ¬¡interruptæ—¶è°ƒç”¨handlerï¼ˆåœ¨IDTä¸­æ³¨å†Œï¼‰ï¼Œåœ¨handlerä¸­è¿›è¡Œä¸€æ¬¡scheduleæ“ä½œ</p> <p>ä½¿ç”¨Chanel0ä½œä¸ºI/O Port <code class="language-plaintext highlighter-rouge">0x40 Channel 0 data port (read/write)</code></p> <p>å‘0x43 portå†™å…¥é€‰æ‹©çš„channelï¼Œmode</p> <h3 id="scheduler">Scheduler</h3> <p>åœ¨è¿›è¡Œå…·ä½“æµç¨‹ä¹‹å‰ï¼Œå¿…é¡»æ˜ç¡®ä¸€ä¸ªäº‹å®ã€‚ä¸€ä¸ªä¸æ˜¯æ­£åœ¨æ‰§è¡Œçš„processçš„stackä¸Šï¼Œ<strong>å¿…ç„¶æ˜¯schedulerçš„æ®‹ç•™ä¿¡æ¯</strong>ï¼Œå› ä¸ºprocessåªè¦å¼€å§‹æ‰§è¡Œï¼Œåªæœ‰ä¸¤ç§å¯èƒ½é€€å‡ºå½“å‰stackï¼š</p> <ol> <li>æ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›user space</li> <li>è¿˜æœªæ‰§è¡Œå®Œæ¯•ï¼Œä½†æ˜¯è¢«schedulerå¼ºåˆ¶é€€å‡ºï¼Œå»å¾€å…¶ä»–process</li> </ol> <p>æ‰€ä»¥åªè¦æˆ‘ä»¬å‘ç°å¯ä»¥æ‰¾åˆ°next processï¼Œé‚£è¿™ä¸ªprocessä¸€å®šæ˜¯å±äº2æƒ…å†µï¼Œå³stackä¸Šæ®‹ç•™äº†ä¸Šä¸€æ¬¡scheduleræœªreturnçš„æ‰€æœ‰ä¿¡æ¯ï¼Œåœ¨æ¥ä¸‹æ¥çš„task switchä¸­ï¼Œä»¥ä¸ºswitchçš„æ—¶å€™ä¾ç„¶ä½¿ç”¨çš„æ˜¯schedulerçš„ä»£ç ï¼Œç›´æ¥æ›´æ”¹espã€ebpå³å¯</p> <p><img src="Untitled17.png" alt="Untitled" width="850"/></p> <h3 id="æ­¥éª¤-3">æ­¥éª¤</h3> <p><strong>æ ¸å¿ƒæ€æƒ³1ï¼šscheduleré€šè¿‡æ›´æ”¹esp, ebpå®ç°åœ¨kernel stackä¹‹é—´çš„åˆ‡æ¢</strong></p> <ol> <li>PITäº§ç”Ÿinterruptï¼Œåœ¨å…¶<code class="language-plaintext highlighter-rouge">pit_handler</code>ä¸­å‘¼å«<code class="language-plaintext highlighter-rouge">scheduler_linkage (asm)</code></li> <li>è¿›å…¥scheduleråï¼Œå…ˆ<strong>å‚¨å­˜æœ¬æ¬¡schedulerè¿›å…¥æ—¶çš„ebp</strong>ï¼Œå‚¨å­˜åˆ°<code class="language-plaintext highlighter-rouge">pcbâ†’sch_ebp</code>ä¸­</li> <li>æ‰¾åˆ°åœ¨schedule arrayä¸­çš„ä¸‹ä¸€ä¸ªéœ€è¦è¢«scheduleçš„processï¼Œä»¥ä¸‹ç§°ä¸º<strong><code class="language-plaintext highlighter-rouge">next process</code></strong>ï¼Œå¹¶æ›´æ–°<code class="language-plaintext highlighter-rouge">cur_sch_index</code>ï¼ˆç”¨æ¥æŒ‡ç¤ºå½“å‰scheduleæ˜¯å“ªä¸ªprocessçš„å˜é‡ï¼‰</li> <li>è‹¥next processçš„pidä¸º-2(TERM_NOT_INITå®)ï¼Œä»£è¡¨ä¸‹ä¸€ä¸ªterminalä¸Šè¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ä»»ä½•è¿›ç¨‹ <ol> <li><code class="language-plaintext highlighter-rouge">remap_video_page(cur_sch_index)</code> æ¥ä¸‹æ¥çš„ä¸€åˆ‡å’Œvideoç›¸å…³æ“ä½œä¼šä½œç”¨åœ¨å³å°†æ–°å¼€å¯çš„shell processä¸Š</li> <li>æ‰§è¡Œ<code class="language-plaintext highlighter-rouge">execute('shell')</code></li> </ol> <aside> â¡ï¸ è¿™æ ·åšå¯ä»¥è§£å†³åˆšå¼€å§‹ä¸‰ä¸ªprocessçš„kernel stackä¸Šéƒ½æ²¡æœ‰scheduleræ®‹ä½™çš„é—®é¢˜ã€‚ä¸‰ä¸ªç©ºçš„kernel stackä¼šä¸€ä¸ªä¸ªè¢«åˆå§‹åŒ–æˆä¸ºæœ‰scheduleræ®‹ä½™çš„kernel stack </aside> </li> <li> <p>å¦‚æœä¸‹ä¸€ä¸ªterminalå·²ç»æœ‰è¿›ç¨‹å¯ä»¥è¢«scheduleäº†ï¼šä¸ºè¿›å…¥user spaceåšå‡†å¤‡ï¼Œå¯¹user programçš„mapè¿›è¡Œè°ƒæ•´ï¼Œå³å¯¹program imageè¿›è¡Œæ›´æ”¹</p> <p>å°†user programéƒ¨åˆ†æŒ‡å‘physical memoryä¸­next processçš„program imageã€‚å’Œexecuteä½¿ç”¨ä¸€ä¸ªæ›´æ”¹user program pagingçš„å‡½æ•°</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="cm">/*   set_user_prog_page
  *   Set page for a user program
  *   input: pid -- the pid of the user program
  *   output: None
  *   side effect: Change the paging directory; Change CR3; flush TLB */</span>
</code></pre></div> </div> </li> <li>æ”¹å˜TSSï¼Œä¸ºå›åˆ°kernel spaceåšå‡†å¤‡</li> <li>remap user video memory</li> <li> <p>å‡†å¤‡context switchåˆ°å³å°†åˆ‡æ¢åˆ°çš„process</p> <p>ä¸èƒ½ç›´æ¥ä½¿ç”¨iretï¼Œè€Œæ˜¯<strong>é‡æ–°è½½å…¥å¦ä¸€ä¸ªprocessçš„ebp</strong>ï¼Œåªæ˜¯ç›¸å½“äºæ¢äº†ä¸€ä¸ªkernel stack</p> <ol> <li>åœ¨schedulerä¸­ï¼Œå°†next process <code class="language-plaintext highlighter-rouge">pcbâ†’ sch_ebp</code>å–å‡ºæ¥ï¼Œè¿™ä¸ªebpå‚¨å­˜çš„æ˜¯ä¸Šä¸€æ¬¡ä»åˆšåˆšè¿›å…¥scheduleræ—¶çš„stack state</li> <li>å°†è¿™ä¸ªpcbâ†’sch_ebpèµ‹å€¼ç»™ebpï¼Œå†leave+retï¼Œå®é™…ä¸Šæ˜¯ä»next process kernel stackä¸Šå›åˆ°äº†pit handler</li> </ol> </li> <li>åœ¨åˆ‡æ¢stackä¹‹åï¼Œå›åˆ°äº†PIT handlerï¼ŒPIT handlerå†returnï¼Œåˆ™å¯ä»¥åˆ©ç”¨PIT lnk(asm)ä¸­çš„iretï¼Œå¯ä»¥switchåˆ°next processçš„user space</li> </ol> <hr/> <p><img src="Untitled18.png" alt="Untitled" width="850"/></p> <p>virtualçš„0xB8000æŒ‡å‘scheduled processçš„backup bufferï¼Œå¦‚æœå’Œdisplay terminalæ˜¯ä¸€ä¸ªï¼Œåˆ™æŒ‡å‘physicalçš„0xB8000</p> <p>é”®ç›˜çš„å­—ç¬¦æ°¸è¿œè¦è¾“å…¥åˆ°physicalçš„0xB8000</p> <h3 id="video-memory-problems">Video memory problems</h3> <p>ä¸Šè¿°å®ç°é€»è¾‘ä¼šé€ æˆvideo memoryå‡ºç°ä¸€å®šçš„é”™ä¹±é—®é¢˜ï¼Œéœ€è¦å¯¹<code class="language-plaintext highlighter-rouge">lib.c</code>ä¸­çš„<code class="language-plaintext highlighter-rouge">putc</code>å‡½æ•°è¿›è¡Œä¸€å®šçš„æ›´æ”¹</p> <p>keyboard interruptå‘¼å«putcï¼Œé»˜è®¤æœ0xB8000è¿›è¡Œè¾“å…¥ã€‚ä½†åœ¨scheduleè¿‡ç¨‹ä¸­ï¼Œ0xB8000å› ä¸ºvideo_remapçš„åŸå› ï¼Œæœªå¿…æ—¶åˆ»æŒ‡å‘çœŸå®çš„video memoryï¼Œå¯èƒ½æŒ‡å‘backup bufferã€‚ä½†å®é™…ä¸Šï¼Œkeyboardçš„è¾“å…¥åº”è¯¥æ˜¾ç¤ºåœ¨å½“å‰å±•ç¤ºçš„terminalä¸Šï¼Œè€Œéå½“å‰scheduledçš„terminalä¸Šã€‚</p> <p>è€Œterminal_writeä¸­å‘¼å«çš„putcï¼Œåˆ™éœ€è¦æ˜¾ç¤ºåœ¨å½“å‰scheduledçš„terminalä¸Šï¼Œè€Œéå½“å‰å±•ç¤ºçš„terminalï¼Œè¿™ä¸keyboardé€»è¾‘æœ‰æ‰€ä¸åŒ</p> <p>åœ¨å·²ç»æä¾›çš„è®¸å¤šuser programä¸­ï¼Œå¤§å¤šæ•°å‘å±å¹•ä¸Šæ‰“å°çš„æ–¹æ³•æ˜¯å‘¼å«terminal_writeï¼Œè€Œ<code class="language-plaintext highlighter-rouge">fish.c</code>æ˜¯ä½¿ç”¨<code class="language-plaintext highlighter-rouge">vidmap</code>ç›´æ¥è·å–åœ°å€ç„¶åä¿®æ”¹å€¼</p> <p>è¿™ä¸€éƒ¨åˆ†æ¯”è¾ƒç¹çç»†ç¢ï¼Œä½†å¹¶ä¸å›°éš¾ï¼Œè¿™ä¸ªç¬”è®°é‡Œä¸è¿‡å¤šèµ˜è¿°ã€‚</p> <hr/> <h1 id="extra-credit">Extra Credit</h1> <h2 id="memory-allocation">Memory Allocation</h2> <p>Two types of memory management</p> <ol> <li>Fixed length memory allocation</li> <li>Varaible length memory allocation</li> </ol> <h3 id="fixed-length--slab-cache">Fixed length â€” Slab Cache</h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="n">this</span> <span class="n">specific</span> <span class="n">implementation</span><span class="p">,</span> <span class="n">fixed</span> <span class="n">length</span> <span class="n">memory</span> <span class="n">allocation</span> <span class="n">is</span> <span class="n">implemented</span> <span class="n">by</span> <span class="n">two</span> <span class="n">parts</span><span class="p">,</span> <span class="n">memory</span> <span class="n">management</span> <span class="n">unit</span> <span class="n">and</span> <span class="n">memory</span> <span class="n">unit</span><span class="p">.</span>
<span class="n">fixed</span> <span class="n">length</span> <span class="n">diagram</span><span class="o">:</span>
        <span class="o">|</span><span class="n">memory</span> <span class="n">management</span> <span class="n">unit</span><span class="o">|</span>  <span class="o">|</span><span class="n">memory</span> <span class="n">management</span> <span class="n">unit</span><span class="o">|</span>  <span class="o">|</span><span class="n">memory</span> <span class="n">management</span> <span class="n">unit</span><span class="o">|</span>  <span class="p">..........</span>    <span class="o">|</span><span class="n">memory</span> <span class="n">unit</span><span class="o">|</span>  <span class="o">|</span><span class="n">memory</span> <span class="n">unit</span><span class="o">|</span> <span class="o">|</span><span class="n">memory</span> <span class="n">unit</span><span class="o">|</span> <span class="p">.....</span>
        <span class="o">|</span><span class="n">next</span><span class="o">|</span>  <span class="o">---------------&gt;</span>  <span class="o">|</span><span class="n">next</span><span class="o">|</span>  <span class="o">---------------&gt;</span>  <span class="o">|</span><span class="n">next</span><span class="o">|</span>                                      <span class="err">â†‘</span>              <span class="err">â†‘</span>             <span class="err">â†‘</span>
        <span class="o">|</span><span class="n">ptr</span><span class="o">|---------------------|</span><span class="n">ptr</span><span class="o">|---------------------|</span><span class="n">ptr</span><span class="o">|---------------------------------------</span><span class="err">â†‘</span><span class="o">--------------</span><span class="err">â†‘</span><span class="o">-------------</span><span class="err">â†‘</span>
</code></pre></div></div> <p>Data structure: Linked list</p> <ul> <li>Slab_Create ( name , size )</li> <li>destroy , malloc , free</li> <li>Automatically shrinks and grows</li> <li>quick and fast to allocate and free</li> <li>granularity: 1byte - 4kB-8 bytes</li> </ul> <h3 id="variable-length--implicit-free-list">Variable length â€” Implicit free list</h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">On</span> <span class="n">the</span> <span class="n">other</span> <span class="n">hand</span><span class="p">,</span> <span class="n">variable</span> <span class="n">length</span> <span class="n">memory</span> <span class="n">allocation</span> <span class="n">is</span> <span class="n">implemented</span> <span class="n">very</span> <span class="n">similar</span> <span class="n">to</span> <span class="n">Linux</span><span class="err">'</span><span class="n">s</span> <span class="n">implicit</span> <span class="n">free</span> <span class="n">list</span> <span class="n">design</span><span class="p">.</span> 
<span class="n">A</span> <span class="n">memory</span> <span class="n">part</span> <span class="n">consists</span> <span class="n">of</span> <span class="n">two</span> <span class="n">parts</span><span class="p">,</span> <span class="n">memory</span> <span class="n">management</span> <span class="n">unit</span> <span class="n">and</span> <span class="n">real</span> <span class="n">useable</span> <span class="n">memory</span> <span class="n">unit</span><span class="p">.</span>
<span class="n">Memory</span> <span class="n">management</span> <span class="n">units</span> <span class="n">are</span> <span class="n">held</span> <span class="n">in</span> <span class="n">a</span> <span class="n">linked</span> <span class="n">list</span> <span class="n">to</span> <span class="n">track</span> <span class="n">each</span> <span class="n">memory</span> <span class="n">fragments</span> <span class="n">have</span> <span class="n">been</span> <span class="n">allocated</span><span class="p">.</span>
<span class="n">variable</span> <span class="n">length</span> <span class="n">diagram</span><span class="o">:</span>
        <span class="o">|</span><span class="n">memory</span> <span class="n">mangement</span> <span class="n">unit</span><span class="o">|</span> <span class="o">-&gt;</span> <span class="o">|</span><span class="n">memory</span> <span class="n">mangement</span> <span class="n">unit</span><span class="o">|</span> <span class="o">-&gt;</span> <span class="o">|</span><span class="n">memory</span> <span class="n">mangement</span> <span class="n">unit</span><span class="o">|</span> <span class="o">-&gt;</span> <span class="o">|</span><span class="n">memory</span> <span class="n">mangement</span> <span class="n">unit</span><span class="o">|</span>
        <span class="o">-----------------------</span>    <span class="o">-----------------------</span>    <span class="o">-----------------------</span>    <span class="o">-----------------------</span>
        <span class="o">|</span>                     <span class="o">|</span>    <span class="o">|</span>                     <span class="o">|</span>    <span class="o">|</span>                     <span class="o">|</span>    <span class="o">|</span>                     <span class="o">|</span>
        <span class="o">|</span>   <span class="n">useable</span> <span class="n">memory</span>    <span class="o">|</span>    <span class="o">|</span>   <span class="n">useable</span> <span class="n">memory</span>    <span class="o">|</span>    <span class="o">|</span>   <span class="n">useable</span> <span class="n">memory</span>    <span class="o">|</span>    <span class="o">|</span>   <span class="n">useable</span> <span class="n">memory</span>    <span class="o">|</span>
        <span class="o">|</span>                     <span class="o">|</span>    <span class="o">|</span>                     <span class="o">|</span>    <span class="o">-----------------------</span>    <span class="o">|</span>                     <span class="o">|</span>
        <span class="o">|</span>                     <span class="o">|</span>    <span class="o">-----------------------</span>                               <span class="o">-----------------------</span>
        <span class="o">|</span>                     <span class="o">|</span>
        <span class="o">-----------------------</span>

<span class="n">Slab</span> <span class="n">cache</span><span class="err">'</span><span class="n">s</span> <span class="n">implementation</span> <span class="n">is</span> <span class="n">based</span> <span class="n">on</span> <span class="n">fixed</span> <span class="n">length</span> <span class="n">memory</span> <span class="n">allocation</span><span class="p">.</span>
</code></pre></div></div> <p>Data structure: Implicit free list</p> <ul> <li>varmalloc( size )</li> <li>flexible: can allocate any size</li> <li>granularity: 1byte - 4MB</li> </ul> <h2 id="signal">Signal</h2> <p>Support users to set handler they define</p> <p>Support sigreturn and set_handler syscall</p> <p>Support five signals:</p> <ol> <li>SIG_DIV_ZERO</li> <li>SIG_SEGFAULT</li> <li>SIG_INTERRUPT</li> <li>SIG_ALARM</li> <li>SIG_USER1</li> </ol> <h2 id="ata-hard-disk-support--file-system">ATA Hard Disk Support &amp; File System</h2> <ul> <li> <p>Writable file system</p> <div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">write</span> <span class="nx">fname</span> <span class="nx">contents</span>
</code></pre></div> </div> </li> <li>Persistent Change (after reboot) by saving the change to the hard drive</li> <li>How the file system is loaded and initialized:</li> </ul> <p><img src="Untitled19.png" alt="Untitled"/></p> <h2 id="speaker-driver">Speaker Driver</h2> <p>Toggle <strong>**</strong><strong>**</strong><strong>NumLock</strong><strong>**</strong><strong>**</strong> to turn on/off</p> <p>Key mapping:</p> <p>(C3~E4) ZSXDCVGBHNJM,L.;/</p> <p>(C4~G5) Q2W3ER5T6Y7UI9O0P[=]</p> <p>Runs concurrently with any user programs &amp; across terminals</p>]]></content><author><name></name></author><category term="course-notes"/><summary type="html"><![CDATA[A tutorial and tips for ECE391 MP3.]]></summary></entry></feed>